# 动态功能部署和测试指南

## 1. 环境准备

### 1.1 数据库准备
确保MySQL数据库中已经创建了相关表：
- `tb_moment` - 动态表
- `tb_moment_media` - 动态媒体表
- `tb_like` - 点赞表
- `tb_comment` - 评论表
- `tb_user` - 用户表

### 1.2 MinIO服务
确保MinIO服务正常运行：
```bash
# 启动MinIO服务（如果使用Docker）
docker run -p 9000:9000 -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v /mnt/data:/data \
  minio/minio server /data --console-address ":9001"
```

### 1.3 依赖检查
确保项目依赖已正确配置：
- MyBatis-Plus
- MySQL驱动
- MinIO客户端
- JWT相关依赖

## 2. 启动服务

### 2.1 启动lovelink-social服务
```bash
cd lovelink-social
mvn spring-boot:run
```

服务将在端口9002启动。

### 2.2 验证服务启动
访问测试接口：
```
GET http://localhost:9002/api/social/test/hello
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": "Social服务运行正常！"
}
```

## 3. 功能测试

### 3.1 获取用户Token
首先需要通过用户服务登录获取JWT token：
```bash
# 用户登录
curl -X POST http://localhost:9001/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "123456"
  }'
```

### 3.2 测试文件上传
```bash
# 上传动态图片
curl -X POST http://localhost:9002/api/social/file/upload/moment \
  -H "token: YOUR_JWT_TOKEN" \
  -F "file=@/path/to/your/image.jpg"
```

预期响应：
```json
{
  "code": 200,
  "message": "success",
  "data": "http://localhost:9000/lovelink/moment/20250721/image_123456.jpg"
}
```

### 3.3 测试发布动态
```bash
# 发布文字动态
curl -X POST http://localhost:9002/api/social/moment/create \
  -H "token: YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "今天天气真好！",
    "location": "北京市朝阳区",
    "visibility": 1
  }'
```

### 3.4 测试查询动态
```bash
# 查询公开动态列表
curl -X GET "http://localhost:9002/api/social/moment/public?pageNum=1&pageSize=10" \
  -H "token: YOUR_JWT_TOKEN"

# 查询我的动态
curl -X GET "http://localhost:9002/api/social/moment/mine?pageNum=1&pageSize=10" \
  -H "token: YOUR_JWT_TOKEN"
```

### 3.5 测试更新动态
```bash
# 更新动态内容
curl -X PUT http://localhost:9002/api/social/moment/update \
  -H "token: YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "momentId": 1,
    "content": "更新后的内容",
    "visibility": 2
  }'
```

### 3.6 测试删除动态
```bash
# 删除动态
curl -X DELETE http://localhost:9002/api/social/moment/delete/1 \
  -H "token: YOUR_JWT_TOKEN"
```

## 4. 常见问题排查

### 4.1 服务启动失败
**问题**: 服务启动时报错
**排查步骤**:
1. 检查数据库连接配置
2. 检查MinIO配置
3. 检查端口是否被占用
4. 查看详细错误日志

### 4.2 文件上传失败
**问题**: 图片上传返回错误
**排查步骤**:
1. 检查MinIO服务是否正常运行
2. 检查MinIO配置参数
3. 检查文件大小和格式限制
4. 检查网络连接

### 4.3 Token验证失败
**问题**: 接口返回401未登录错误
**排查步骤**:
1. 检查token是否正确传递
2. 检查token是否过期
3. 检查JWT密钥配置
4. 检查请求头格式

### 4.4 数据库操作失败
**问题**: 数据保存或查询失败
**排查步骤**:
1. 检查数据库表结构
2. 检查字段映射
3. 检查SQL语句
4. 查看MyBatis日志

## 5. 性能优化建议

### 5.1 数据库优化
- 为常用查询字段添加索引
- 使用分页查询避免大量数据加载
- 考虑读写分离

### 5.2 文件存储优化
- 配置CDN加速图片访问
- 实现图片压缩和格式转换
- 设置合理的缓存策略

### 5.3 接口优化
- 实现接口缓存
- 使用异步处理提高响应速度
- 添加接口限流防止滥用

## 6. 监控和日志

### 6.1 日志配置
在`application.yml`中配置详细日志：
```yaml
logging:
  level:
    com.zhentao: debug
    org.springframework.web: debug
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 6.2 关键指标监控
- 接口响应时间
- 文件上传成功率
- 数据库连接池状态
- 内存使用情况

## 7. 安全注意事项

### 7.1 文件上传安全
- 验证文件类型和大小
- 防止恶意文件上传
- 设置合理的存储限制

### 7.2 接口安全
- 实现接口限流
- 添加参数验证
- 防止SQL注入

### 7.3 数据安全
- 敏感数据加密存储
- 实现数据备份策略
- 定期清理无效数据

## 8. 扩展功能建议

### 8.1 短期扩展
- 添加动态点赞功能
- 实现评论系统
- 支持视频上传

### 8.2 长期扩展
- 实现动态推荐算法
- 添加话题标签系统
- 支持动态分享功能
- 实现消息通知系统

## 9. 部署到生产环境

### 9.1 配置调整
```yaml
# 生产环境配置
spring:
  datasource:
    url: jdbc:mysql://prod-db-host:3306/lovelink
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

minio:
  endpoint: https://your-minio-domain.com
  accessKey: ${MINIO_ACCESS_KEY}
  secretKey: ${MINIO_SECRET_KEY}

logging:
  level:
    com.zhentao: info
    root: warn
```

### 9.2 Docker部署
```dockerfile
FROM openjdk:11-jre-slim

COPY target/lovelink-social-1.0-SNAPSHOT.jar app.jar

EXPOSE 9002

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### 9.3 健康检查
```yaml
# docker-compose.yml
version: '3.8'
services:
  lovelink-social:
    build: .
    ports:
      - "9002:9002"
    environment:
      - DB_USERNAME=root
      - DB_PASSWORD=password
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9002/api/social/test/hello"]
      interval: 30s
      timeout: 10s
      retries: 3
```
