# 虚拟币余额显示功能实现说明

## 🎯 功能概述

在心动速配的费用确认弹窗中显示用户当前虚拟币余额，让用户清楚了解扣费前后的余额情况。

## ✨ 新增功能

### 1. 余额信息显示
- **当前余额**：显示用户当前虚拟币余额
- **消耗金额**：显示本次操作需要消耗的虚拟币数量（5币）
- **扣减后余额**：实时计算并显示扣费后的剩余余额
- **余额不足提示**：当余额不足时，显示红色警告文字

### 2. 智能按钮状态
- **余额充足**：按钮显示"开始匹配"，可以正常点击
- **余额不足**：按钮显示"余额不足"，禁用状态，无法点击
- **加载中**：获取余额时显示"加载中..."状态

### 3. 后端数据增强
- 消费接口返回详细的余额信息
- 包含扣减前余额、扣减后余额、消费金额等详细数据

## 🔧 技术实现

### 后端改进

#### 修改文件：`WalletServiceImpl.java`

```java
// 构建返回数据，包含余额信息
Map<String, Object> resultData = new HashMap<>();
resultData.put("message", "消费成功");
resultData.put("consumeAmount", coinAmount);
resultData.put("beforeBalance", wallet.getCoinBalance() + coinAmount); // 扣减前余额
resultData.put("afterBalance", wallet.getCoinBalance()); // 扣减后余额
resultData.put("transactionDesc", walletDTO.getTransactionDesc());

return Result.OK(resultData);
```

**返回数据结构：**
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "message": "消费成功",
    "consumeAmount": 5,
    "beforeBalance": 100,
    "afterBalance": 95,
    "transactionDesc": "心动速配"
  }
}
```

### 前端改进

#### 修改文件：`heart-match.vue`

**新增数据字段：**
```javascript
data() {
  return {
    currentBalance: 0, // 当前虚拟币余额
    loadingBalance: false // 是否正在加载余额
  }
}
```

**新增方法：**
```javascript
// 加载用户余额
async loadUserBalance() {
  try {
    this.loadingBalance = true
    const response = await getWalletInfo()
    
    if (response.code === 200) {
      this.currentBalance = response.data.coinBalance || 0
    }
  } catch (error) {
    this.currentBalance = 0
  } finally {
    this.loadingBalance = false
  }
}
```

## 🎨 UI设计改进

### 费用信息框布局

```vue
<view class="cost-info-box">
  <!-- 当前余额 -->
  <view class="balance-info">
    <text class="balance-label">当前余额：</text>
    <text class="balance-amount" :class="{ insufficient: currentBalance < 5 }">
      {{ loadingBalance ? '加载中...' : currentBalance + '币' }}
    </text>
  </view>
  
  <!-- 消耗金额 -->
  <view class="cost-row">
    <text class="cost-label">消耗虚拟币：</text>
    <text class="cost-amount">5币</text>
  </view>
  
  <!-- 扣减后余额 -->
  <view class="after-balance-row">
    <text class="after-label">扣减后余额：</text>
    <text class="after-amount" :class="{ insufficient: currentBalance < 5 }">
      {{ loadingBalance ? '计算中...' : (currentBalance >= 5 ? (currentBalance - 5) + '币' : '余额不足') }}
    </text>
  </view>
</view>
```

### 颜色方案

- **余额充足**：绿色 `#2ecc71`
- **余额不足**：红色 `#e74c3c`
- **消耗金额**：橙红色 `#ff4757`
- **扣减后余额**：蓝色 `#3498db`

## 📱 用户体验流程

### 场景1：余额充足（≥5币）

1. 用户点击"开始匹配"
2. 显示费用确认弹窗
3. 弹窗显示：
   - 当前余额：100币（绿色）
   - 消耗虚拟币：5币（红色）
   - 扣减后余额：95币（蓝色）
4. "开始匹配"按钮可点击
5. 点击确认后执行扣费和匹配

### 场景2：余额不足（<5币）

1. 用户点击"开始匹配"
2. 显示费用确认弹窗
3. 弹窗显示：
   - 当前余额：3币（红色）
   - 消耗虚拟币：5币（红色）
   - 扣减后余额：余额不足（红色）
4. "余额不足"按钮禁用状态（灰色）
5. 点击按钮会弹出充值引导

### 场景3：加载状态

1. 弹窗显示时正在获取余额
2. 显示：
   - 当前余额：加载中...
   - 扣减后余额：计算中...
3. 按钮显示"加载中..."并禁用
4. 加载完成后更新显示

## 🔍 测试要点

### 功能测试

1. **余额充足测试**：
   - 确保余额≥5币时，所有信息正确显示
   - 按钮可正常点击，扣费成功

2. **余额不足测试**：
   - 确保余额<5币时，显示红色警告
   - 按钮禁用，点击后引导充值

3. **边界值测试**：
   - 余额正好5币时的显示
   - 余额为0时的显示

4. **网络异常测试**：
   - 获取余额失败时的处理
   - 网络延迟时的加载状态

### UI测试

1. **颜色显示**：
   - 余额充足时为绿色
   - 余额不足时为红色
   - 各个数值颜色正确

2. **响应式布局**：
   - 不同屏幕尺寸下的显示效果
   - 文字长度变化时的布局适应

3. **动画效果**：
   - 弹窗出现动画
   - 按钮点击反馈

## 🚀 后续优化建议

1. **缓存优化**：
   - 缓存用户余额信息，减少重复请求
   - 在其他页面消费后及时更新缓存

2. **实时更新**：
   - 使用WebSocket实时更新余额变化
   - 多端同步余额信息

3. **用户体验**：
   - 添加余额变化动画效果
   - 提供快速充值入口

4. **数据统计**：
   - 记录用户查看余额的行为
   - 分析余额不足对转化率的影响

## 📊 预期效果

1. **透明度提升**：用户清楚了解消费情况
2. **转化率优化**：余额不足时引导充值
3. **用户体验**：减少因余额不足导致的操作失败
4. **数据准确性**：实时显示最新余额信息
