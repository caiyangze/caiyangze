# 红娘申请功能实现说明

## 🎯 功能概述

实现用户申请成为红娘的完整流程，包括表单填写、虚拟币扣减（699币）、申请提交和审核等功能。

## ✨ 主要功能

### 1. 申请费用机制
- **费用标准**：699个虚拟币
- **扣费时机**：申请提交时立即扣除
- **余额检查**：提交前验证用户余额是否充足
- **交易记录**：自动创建消费记录

### 2. 申请表单验证
- **基本信息**：真实姓名、联系电话、身份证号、服务区域
- **身份证照片**：正面和背面照片上传
- **个人资料**：个人介绍（100-500字）、相关经验（100-500字）
- **实时验证**：表单字段实时验证和提示

### 3. 申请流程控制
- **前置条件检查**：手机号绑定、性别选择、实名认证
- **重复申请防护**：同一用户不能重复申请
- **事务性操作**：扣费和申请记录创建在同一事务中

## 🔧 技术实现

### 后端实现

#### 修改文件：`MatchmakerInfoController.java`

**主要改进：**
```java
@PostMapping("/apply")
@Transactional(rollbackFor = Exception.class)
public Result applyMatchmaker(@RequestBody MatchmakerApplicationDto dto, @RequestHeader("token") String token) {
    // 1. 用户身份验证和前置条件检查
    // 2. 虚拟币扣减（699币）
    WalletDTO walletDTO = new WalletDTO();
    walletDTO.setUserId(userId);
    walletDTO.setCoinAmount(699);
    walletDTO.setTransactionDesc("申请成为红娘");
    walletDTO.setRelatedId("MATCHMAKER_APPLY_" + System.currentTimeMillis());
    
    Result consumeResult = walletService.consume(walletDTO);
    if (consumeResult.getCode() != 200) {
        return consumeResult; // 余额不足或其他错误
    }
    
    // 3. 创建申请记录
    // 4. 返回申请结果和扣费信息
}
```

**前置条件检查：**
- 用户已绑定手机号
- 用户已选择性别
- 用户已完成实名认证
- 用户尚未成为红娘（避免重复申请）
- 拥有足够的虚拟币余额（699币）

**申请开放性：**
- 任何用户都可以申请，无需VIP身份
- 无需内部人员推荐
- 只要满足基本条件即可申请

### 前端实现

#### 新增文件：`pages/matchmaker/apply.vue`

**页面结构：**
1. **费用提示横幅**：显示申请费用699币
2. **基本信息表单**：姓名、电话、身份证、服务区域
3. **身份证照片上传**：正面和背面照片
4. **个人资料填写**：介绍和经验（带字数统计）
5. **费用确认弹窗**：显示当前余额和扣费金额
6. **提交按钮**：智能状态管理

**关键特性：**
- 实时表单验证
- 余额不足时禁用提交
- 上传进度和状态提示
- 字数统计和限制
- 响应式设计

#### 新增文件：`api/matchmaker.js`

**API接口：**
```javascript
// 申请成为红娘
export const applyMatchmaker = (data) => {
  return http.post('/matchmaker/info/apply', data)
}

// 表单验证
export const validateApplicationForm = (formData) => {
  // 完整的表单验证逻辑
}
```

## 🎨 UI设计特点

### 1. 费用提示横幅
```vue
<view class="cost-banner">
  <view class="cost-icon">💰</view>
  <view class="cost-info">
    <text class="cost-title">申请费用：699虚拟币</text>
    <text class="cost-desc">成为专业红娘，开启收益之路</text>
  </view>
</view>
```

### 2. 表单设计
- **分组布局**：基本信息、身份证照片、个人介绍
- **输入框样式**：圆角设计，聚焦时高亮
- **上传组件**：拖拽式上传，预览功能
- **字数统计**：实时显示字数和限制

### 3. 确认弹窗
- **余额显示**：当前余额和扣费后余额
- **状态指示**：余额充足/不足的颜色区分
- **按钮状态**：余额不足时禁用确认按钮

## 📱 用户体验流程

### 正常申请流程
1. 用户进入申请页面
2. 查看费用提示（699币）
3. 填写基本信息表单
4. 上传身份证照片
5. 填写个人介绍和经验
6. 点击提交申请
7. 显示费用确认弹窗
8. 确认扣费并提交
9. 显示申请成功提示

### 异常情况处理
1. **余额不足**：显示充值引导
2. **表单验证失败**：高亮错误字段
3. **网络错误**：重试提示
4. **重复申请**：友好提示

## 🔍 数据库变更

### 申请记录表（tb_matchmaker_application）
```sql
-- 申请时会创建记录
INSERT INTO tb_matchmaker_application (
    user_id, real_name, phone, id_card_no, 
    id_card_front, id_card_back, service_area,
    introduction, experience, application_status,
    created_at, updated_at
) VALUES (...)
```

### 钱包交易记录（tb_wallet_transaction）
```sql
-- 扣费时会创建交易记录
INSERT INTO tb_wallet_transaction (
    user_id, transaction_type, coin_amount,
    transaction_desc, related_id, created_at
) VALUES (
    user_id, 2, 699, 
    '申请成为红娘', 'MATCHMAKER_APPLY_timestamp', NOW()
)
```

## 🚀 后续扩展功能

### 1. 申请状态查询
- 查看申请进度
- 审核结果通知
- 拒绝原因显示

### 2. 申请记录管理
- 申请历史查看
- 重新申请功能
- 申请信息修改

### 3. 费用优化
- VIP用户折扣
- 活动期间优惠
- 分期付款选项

### 4. 审核流程
- 管理员审核界面
- 审核状态流转
- 自动化审核规则

## 📊 预期效果

1. **用户转化**：提供清晰的申请流程，提高转化率
2. **费用透明**：明确显示费用，避免用户疑虑
3. **操作便捷**：简化申请步骤，提升用户体验
4. **数据完整**：收集完整的申请信息，便于审核

## ⚠️ 注意事项

1. **身份证信息安全**：需要加密存储身份证号
2. **照片存储**：身份证照片需要安全存储
3. **审核机制**：需要建立完善的审核流程
4. **退费机制**：考虑申请被拒绝时的退费政策

## 🔧 开发建议

1. **图片上传**：集成云存储服务（如阿里云OSS）
2. **表单验证**：前后端双重验证确保数据安全
3. **状态管理**：使用Vuex管理申请状态
4. **错误处理**：完善的错误提示和重试机制
