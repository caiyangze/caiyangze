# 心动速配费用确认功能实现说明

## 功能概述

为心动速配功能添加了费用确认机制，用户在进行心动速配时会提示消耗5个虚拟币，并提供"不再提示"选项。

## 实现的功能

### 1. 后端实现 (Java Spring Boot)

#### 修改文件：`lovelink-user/src/main/java/com/zhentao/service/impl/UserServiceImpl.java`

**主要改动：**
- 添加了 `WalletService` 依赖注入
- 在 `randomMatchByGender` 方法中添加了 `@Transactional` 注解
- 在匹配逻辑前先调用钱包扣减功能：
  ```java
  // 1. 先检查并扣减虚拟币（心动速配消耗5个虚拟币）
  WalletDTO walletDTO = new WalletDTO();
  walletDTO.setUserId(currentUserId);
  walletDTO.setCoinAmount(5);
  walletDTO.setTransactionDesc("心动速配");
  walletDTO.setRelatedId("HEART_MATCH_" + System.currentTimeMillis());
  
  Result consumeResult = walletService.consume(walletDTO);
  if (consumeResult.getCode() != 200) {
      return consumeResult; // 返回钱包扣减失败的结果（如余额不足等）
  }
  ```

**功能特点：**
- 事务性操作：如果匹配失败，虚拟币扣减会回滚
- 自动创建消费记录：每次心动速配都会在 `tb_wallet_transaction` 表中创建记录
- 余额检查：如果用户虚拟币不足，会返回相应错误信息

### 2. 前端实现 (Vue.js + uni-app)

#### 修改文件：`abab_uniapp/pages/game/heart-match.vue`

**主要改动：**

1. **添加费用提示**：
   - 在页面上显示"💰 每次心动速配消耗 5 个虚拟币"

2. **费用确认弹窗**：
   - 自定义弹窗设计，包含费用说明
   - "不再提示"复选框选项
   - 确定/取消按钮

3. **本地存储管理**：
   - 使用 `uni.getStorageSync('dontShowCostConfirm')` 记录用户选择
   - 如果用户选择"不再提示"，后续直接执行匹配

4. **设置功能**：
   - 右上角设置按钮（⚙️图标）
   - 可以重新启用费用提示功能

5. **错误处理优化**：
   - 余额不足时显示充值引导弹窗
   - 提供跳转到钱包页面的选项

## 用户体验流程

### 首次使用或未设置"不再提示"：
1. 用户选择性别
2. 点击"开始匹配"
3. 显示费用确认弹窗
4. 用户可选择"不再提示"
5. 点击"确定"开始匹配并扣费

### 已设置"不再提示"：
1. 用户选择性别
2. 点击"开始匹配"
3. 直接开始匹配并扣费（无弹窗）

### 余额不足情况：
1. 显示余额不足提示
2. 提供跳转到钱包充值的选项

### 重新启用提示：
1. 点击右上角设置按钮
2. 选择"启用提示"
3. 下次匹配时会重新显示费用确认

## 技术特点

1. **数据一致性**：使用事务确保扣费和匹配的原子性
2. **用户体验**：提供灵活的提示设置选项
3. **错误处理**：完善的余额检查和错误提示
4. **界面设计**：美观的自定义弹窗设计
5. **状态管理**：合理使用本地存储管理用户偏好

## 数据库影响

每次心动速配会在以下表中产生记录：
- `tb_user_wallet`：更新用户虚拟币余额和累计消费
- `tb_wallet_transaction`：创建消费记录，包含交易类型、金额、描述等信息

## 配置说明

- **消费金额**：固定为5个虚拟币
- **交易描述**：固定为"心动速配"
- **关联ID**：格式为 "HEART_MATCH_" + 时间戳
- **本地存储键**：`dontShowCostConfirm`（布尔值）

## 后续扩展建议

1. 可以考虑添加VIP用户免费或折扣功能
2. 可以添加每日免费次数限制
3. 可以添加消费统计和历史记录查看
4. 可以考虑添加退款机制（匹配失败时）
