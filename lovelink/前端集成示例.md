# 前端集成示例

## uni-app集成示例

### 1. 创建动态API服务

```javascript
// api/moment.js
import http from './http'

const momentApi = {
  /**
   * 发布动态
   * @param {Object} data - 动态数据
   * @param {Array} mediaFiles - 媒体文件数组
   */
  createMoment(data, mediaFiles = []) {
    const formData = new FormData();
    formData.append('content', data.content);
    if (data.location) formData.append('location', data.location);
    if (data.visibility) formData.append('visibility', data.visibility);
    
    // 添加媒体文件
    mediaFiles.forEach((file, index) => {
      formData.append('mediaFiles', file);
    });
    
    return http.request({
      url: '/api/social/moment/create',
      method: 'POST',
      data: formData,
      header: {
        'Content-Type': 'multipart/form-data'
      }
    });
  },

  /**
   * 上传动态图片
   * @param {String} filePath - 本地文件路径
   */
  uploadMomentImage(filePath) {
    return new Promise((resolve, reject) => {
      uni.uploadFile({
        url: http.baseUrl + '/api/social/file/upload/moment',
        filePath: filePath,
        name: 'file',
        header: {
          'token': uni.getStorageSync('token') || ''
        },
        success: (res) => {
          try {
            const data = JSON.parse(res.data);
            resolve(data);
          } catch (e) {
            reject(e);
          }
        },
        fail: (err) => {
          reject(err);
        }
      });
    });
  },

  /**
   * 查询公开动态列表
   * @param {Number} pageNum - 页码
   * @param {Number} pageSize - 页大小
   */
  getPublicMoments(pageNum = 1, pageSize = 10) {
    return http.request({
      url: `/api/social/moment/public?pageNum=${pageNum}&pageSize=${pageSize}`,
      method: 'GET'
    });
  },

  /**
   * 查询我的动态列表
   * @param {Number} pageNum - 页码
   * @param {Number} pageSize - 页大小
   */
  getMyMoments(pageNum = 1, pageSize = 10) {
    return http.request({
      url: `/api/social/moment/mine?pageNum=${pageNum}&pageSize=${pageSize}`,
      method: 'GET'
    });
  },

  /**
   * 更新动态
   * @param {Object} data - 更新数据
   */
  updateMoment(data) {
    return http.request({
      url: '/api/social/moment/update',
      method: 'PUT',
      data: data
    });
  },

  /**
   * 删除动态
   * @param {Number} momentId - 动态ID
   */
  deleteMoment(momentId) {
    return http.request({
      url: `/api/social/moment/delete/${momentId}`,
      method: 'DELETE'
    });
  },

  /**
   * 更新动态可见性
   * @param {Number} momentId - 动态ID
   * @param {Number} visibility - 可见性
   */
  updateMomentVisibility(momentId, visibility) {
    return http.request({
      url: `/api/social/moment/visibility/${momentId}?visibility=${visibility}`,
      method: 'PUT'
    });
  }
};

export default momentApi;
```

### 2. 发布动态页面

```vue
<!-- pages/moment/publish.vue -->
<template>
  <view class="publish-container">
    <view class="header">
      <button @tap="goBack" class="cancel-btn">取消</button>
      <text class="title">发布动态</text>
      <button @tap="publishMoment" class="publish-btn" :disabled="!canPublish">发布</button>
    </view>

    <view class="content-area">
      <textarea 
        v-model="momentData.content" 
        placeholder="分享你的生活..." 
        class="content-input"
        maxlength="1000"
        :show-count="true"
      ></textarea>
    </view>

    <view class="media-area">
      <view class="media-grid">
        <view 
          v-for="(image, index) in selectedImages" 
          :key="index" 
          class="media-item"
        >
          <image :src="image.url" class="media-image" @tap="previewImage(index)"></image>
          <view class="delete-btn" @tap="removeImage(index)">×</view>
        </view>
        
        <view 
          v-if="selectedImages.length < 9" 
          class="add-media-btn" 
          @tap="chooseImage"
        >
          <text class="add-icon">+</text>
        </view>
      </view>
    </view>

    <view class="options-area">
      <view class="option-item" @tap="chooseLocation">
        <text class="option-icon">📍</text>
        <text class="option-text">{{ momentData.location || '添加位置' }}</text>
      </view>
      
      <view class="option-item" @tap="chooseVisibility">
        <text class="option-icon">👁️</text>
        <text class="option-text">{{ visibilityText }}</text>
      </view>
    </view>
  </view>
</template>

<script setup>
import { reactive, ref, computed } from 'vue';
import momentApi from '@/api/moment';

// 动态数据
const momentData = reactive({
  content: '',
  location: '',
  visibility: 1 // 1-公开，2-仅关注者，3-仅自己
});

// 选中的图片
const selectedImages = ref([]);

// 是否可以发布
const canPublish = computed(() => {
  return momentData.content.trim().length > 0;
});

// 可见性文本
const visibilityText = computed(() => {
  const texts = { 1: '公开', 2: '仅关注者可见', 3: '仅自己可见' };
  return texts[momentData.visibility];
});

// 选择图片
function chooseImage() {
  const remainCount = 9 - selectedImages.value.length;
  
  uni.chooseImage({
    count: remainCount,
    sizeType: ['compressed'],
    sourceType: ['album', 'camera'],
    success: (res) => {
      res.tempFilePaths.forEach(path => {
        selectedImages.value.push({
          url: path,
          file: null // 实际文件对象在上传时处理
        });
      });
    }
  });
}

// 移除图片
function removeImage(index) {
  selectedImages.value.splice(index, 1);
}

// 预览图片
function previewImage(index) {
  const urls = selectedImages.value.map(img => img.url);
  uni.previewImage({
    current: index,
    urls: urls
  });
}

// 选择位置
function chooseLocation() {
  uni.chooseLocation({
    success: (res) => {
      momentData.location = res.name || res.address;
    }
  });
}

// 选择可见性
function chooseVisibility() {
  uni.showActionSheet({
    itemList: ['公开', '仅关注者可见', '仅自己可见'],
    success: (res) => {
      momentData.visibility = res.tapIndex + 1;
    }
  });
}

// 发布动态
async function publishMoment() {
  if (!canPublish.value) {
    uni.showToast({
      title: '请输入动态内容',
      icon: 'none'
    });
    return;
  }

  uni.showLoading({
    title: '发布中...'
  });

  try {
    // 1. 先上传图片
    const uploadPromises = selectedImages.value.map(async (image) => {
      const result = await momentApi.uploadMomentImage(image.url);
      return result.data; // 返回图片URL
    });

    const imageUrls = await Promise.all(uploadPromises);

    // 2. 发布动态
    const publishData = {
      content: momentData.content,
      location: momentData.location,
      visibility: momentData.visibility,
      imageUrls: imageUrls
    };

    await momentApi.createMoment(publishData);

    uni.hideLoading();
    uni.showToast({
      title: '发布成功',
      icon: 'success'
    });

    // 返回上一页
    setTimeout(() => {
      uni.navigateBack();
    }, 1500);

  } catch (error) {
    uni.hideLoading();
    console.error('发布失败:', error);
    uni.showToast({
      title: '发布失败，请重试',
      icon: 'none'
    });
  }
}

// 返回
function goBack() {
  uni.navigateBack();
}
</script>

<style scoped>
.publish-container {
  min-height: 100vh;
  background-color: #f8f8f8;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 30rpx;
  background-color: #fff;
  border-bottom: 1rpx solid #eee;
}

.cancel-btn, .publish-btn {
  padding: 10rpx 20rpx;
  border: none;
  background: none;
  font-size: 32rpx;
}

.cancel-btn {
  color: #666;
}

.publish-btn {
  color: #007aff;
}

.publish-btn:disabled {
  color: #ccc;
}

.title {
  font-size: 36rpx;
  font-weight: bold;
}

.content-area {
  padding: 30rpx;
  background-color: #fff;
  margin-bottom: 20rpx;
}

.content-input {
  width: 100%;
  min-height: 200rpx;
  font-size: 32rpx;
  line-height: 1.5;
  border: none;
  outline: none;
}

.media-area {
  padding: 30rpx;
  background-color: #fff;
  margin-bottom: 20rpx;
}

.media-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20rpx;
}

.media-item {
  position: relative;
  width: 200rpx;
  height: 200rpx;
}

.media-image {
  width: 100%;
  height: 100%;
  border-radius: 10rpx;
}

.delete-btn {
  position: absolute;
  top: -10rpx;
  right: -10rpx;
  width: 40rpx;
  height: 40rpx;
  background-color: #ff4757;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24rpx;
}

.add-media-btn {
  width: 200rpx;
  height: 200rpx;
  border: 2rpx dashed #ccc;
  border-radius: 10rpx;
  display: flex;
  align-items: center;
  justify-content: center;
}

.add-icon {
  font-size: 60rpx;
  color: #ccc;
}

.options-area {
  background-color: #fff;
}

.option-item {
  display: flex;
  align-items: center;
  padding: 30rpx;
  border-bottom: 1rpx solid #eee;
}

.option-icon {
  margin-right: 20rpx;
  font-size: 32rpx;
}

.option-text {
  font-size: 32rpx;
  color: #333;
}
</style>
```

### 3. 动态列表页面

```vue
<!-- pages/moment/list.vue -->
<template>
  <view class="moment-list">
    <scroll-view 
      scroll-y 
      class="scroll-area"
      @scrolltolower="loadMore"
      refresher-enabled
      @refresherrefresh="onRefresh"
      :refresher-triggered="refreshing"
    >
      <view 
        v-for="moment in momentList" 
        :key="moment.momentId" 
        class="moment-item"
      >
        <!-- 用户信息 -->
        <view class="user-info">
          <image :src="moment.avatarUrl" class="avatar"></image>
          <view class="user-details">
            <text class="nickname">{{ moment.nickname }}</text>
            <text class="time">{{ formatTime(moment.createdAt) }}</text>
          </view>
          <view v-if="moment.isMine" class="more-btn" @tap="showMoreOptions(moment)">
            <text>⋯</text>
          </view>
        </view>

        <!-- 动态内容 -->
        <view class="content">
          <text>{{ moment.content }}</text>
        </view>

        <!-- 位置信息 -->
        <view v-if="moment.location" class="location">
          <text class="location-icon">📍</text>
          <text class="location-text">{{ moment.location }}</text>
        </view>

        <!-- 媒体内容 -->
        <view v-if="moment.mediaList && moment.mediaList.length > 0" class="media-grid">
          <image 
            v-for="(media, index) in moment.mediaList" 
            :key="media.mediaId"
            :src="media.mediaUrl" 
            class="media-image"
            @tap="previewImages(moment.mediaList, index)"
          ></image>
        </view>

        <!-- 互动区域 -->
        <view class="actions">
          <view class="action-item" @tap="toggleLike(moment)">
            <text :class="['action-icon', moment.isLiked ? 'liked' : '']">❤️</text>
            <text class="action-text">{{ moment.likeCount || '点赞' }}</text>
          </view>
          <view class="action-item" @tap="showComments(moment)">
            <text class="action-icon">💬</text>
            <text class="action-text">{{ moment.commentCount || '评论' }}</text>
          </view>
          <view class="action-item">
            <text class="action-icon">👁️</text>
            <text class="action-text">{{ moment.viewCount || '浏览' }}</text>
          </view>
        </view>
      </view>

      <view v-if="loading" class="loading">
        <text>加载中...</text>
      </view>

      <view v-if="noMore" class="no-more">
        <text>没有更多了</text>
      </view>
    </scroll-view>

    <!-- 发布按钮 -->
    <view class="fab" @tap="goToPublish">
      <text class="fab-icon">+</text>
    </view>
  </view>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import momentApi from '@/api/moment';

// 数据
const momentList = ref([]);
const loading = ref(false);
const refreshing = ref(false);
const noMore = ref(false);
const currentPage = ref(1);
const pageSize = 10;

// 页面加载
onMounted(() => {
  loadMomentList();
});

// 加载动态列表
async function loadMomentList(isRefresh = false) {
  if (loading.value) return;
  
  loading.value = true;
  
  try {
    const page = isRefresh ? 1 : currentPage.value;
    const result = await momentApi.getPublicMoments(page, pageSize);
    
    if (isRefresh) {
      momentList.value = result.data.records;
      currentPage.value = 1;
      noMore.value = false;
    } else {
      momentList.value.push(...result.data.records);
    }
    
    // 检查是否还有更多数据
    if (result.data.records.length < pageSize) {
      noMore.value = true;
    } else {
      currentPage.value++;
    }
    
  } catch (error) {
    console.error('加载动态列表失败:', error);
    uni.showToast({
      title: '加载失败',
      icon: 'none'
    });
  } finally {
    loading.value = false;
    refreshing.value = false;
  }
}

// 下拉刷新
function onRefresh() {
  refreshing.value = true;
  loadMomentList(true);
}

// 加载更多
function loadMore() {
  if (!noMore.value) {
    loadMomentList();
  }
}

// 格式化时间
function formatTime(timeStr) {
  const time = new Date(timeStr);
  const now = new Date();
  const diff = now - time;
  
  if (diff < 60000) return '刚刚';
  if (diff < 3600000) return Math.floor(diff / 60000) + '分钟前';
  if (diff < 86400000) return Math.floor(diff / 3600000) + '小时前';
  return Math.floor(diff / 86400000) + '天前';
}

// 预览图片
function previewImages(mediaList, currentIndex) {
  const urls = mediaList.map(media => media.mediaUrl);
  uni.previewImage({
    current: currentIndex,
    urls: urls
  });
}

// 跳转到发布页面
function goToPublish() {
  uni.navigateTo({
    url: '/pages/moment/publish'
  });
}

// 显示更多选项
function showMoreOptions(moment) {
  uni.showActionSheet({
    itemList: ['编辑', '删除', '设置可见性'],
    success: (res) => {
      switch (res.tapIndex) {
        case 0:
          editMoment(moment);
          break;
        case 1:
          deleteMoment(moment);
          break;
        case 2:
          changeVisibility(moment);
          break;
      }
    }
  });
}

// 编辑动态
function editMoment(moment) {
  uni.navigateTo({
    url: `/pages/moment/edit?momentId=${moment.momentId}`
  });
}

// 删除动态
function deleteMoment(moment) {
  uni.showModal({
    title: '确认删除',
    content: '确定要删除这条动态吗？',
    success: async (res) => {
      if (res.confirm) {
        try {
          await momentApi.deleteMoment(moment.momentId);
          // 从列表中移除
          const index = momentList.value.findIndex(m => m.momentId === moment.momentId);
          if (index > -1) {
            momentList.value.splice(index, 1);
          }
          uni.showToast({
            title: '删除成功',
            icon: 'success'
          });
        } catch (error) {
          uni.showToast({
            title: '删除失败',
            icon: 'none'
          });
        }
      }
    }
  });
}

// 更改可见性
function changeVisibility(moment) {
  uni.showActionSheet({
    itemList: ['公开', '仅关注者可见', '仅自己可见'],
    success: async (res) => {
      const visibility = res.tapIndex + 1;
      try {
        await momentApi.updateMomentVisibility(moment.momentId, visibility);
        moment.visibility = visibility;
        uni.showToast({
          title: '设置成功',
          icon: 'success'
        });
      } catch (error) {
        uni.showToast({
          title: '设置失败',
          icon: 'none'
        });
      }
    }
  });
}
</script>

<style scoped>
.moment-list {
  height: 100vh;
  background-color: #f8f8f8;
}

.scroll-area {
  height: 100%;
}

.moment-item {
  background-color: #fff;
  margin-bottom: 20rpx;
  padding: 30rpx;
}

.user-info {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
}

.avatar {
  width: 80rpx;
  height: 80rpx;
  border-radius: 50%;
  margin-right: 20rpx;
}

.user-details {
  flex: 1;
}

.nickname {
  display: block;
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.time {
  display: block;
  font-size: 24rpx;
  color: #999;
  margin-top: 5rpx;
}

.more-btn {
  padding: 10rpx;
  font-size: 32rpx;
  color: #999;
}

.content {
  font-size: 32rpx;
  line-height: 1.5;
  color: #333;
  margin-bottom: 20rpx;
}

.location {
  display: flex;
  align-items: center;
  margin-bottom: 20rpx;
}

.location-icon {
  margin-right: 10rpx;
  font-size: 24rpx;
}

.location-text {
  font-size: 28rpx;
  color: #666;
}

.media-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10rpx;
  margin-bottom: 20rpx;
}

.media-image {
  width: 200rpx;
  height: 200rpx;
  border-radius: 10rpx;
}

.actions {
  display: flex;
  justify-content: space-around;
  padding-top: 20rpx;
  border-top: 1rpx solid #eee;
}

.action-item {
  display: flex;
  align-items: center;
  padding: 10rpx 20rpx;
}

.action-icon {
  margin-right: 10rpx;
  font-size: 32rpx;
}

.action-icon.liked {
  color: #ff4757;
}

.action-text {
  font-size: 28rpx;
  color: #666;
}

.fab {
  position: fixed;
  bottom: 100rpx;
  right: 50rpx;
  width: 100rpx;
  height: 100rpx;
  background-color: #007aff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4rpx 12rpx rgba(0, 122, 255, 0.3);
}

.fab-icon {
  color: #fff;
  font-size: 48rpx;
  font-weight: bold;
}

.loading, .no-more {
  text-align: center;
  padding: 40rpx;
  color: #999;
  font-size: 28rpx;
}
</style>
```

## 注意事项

1. **Token管理**: 确保在所有需要认证的请求中正确传递JWT token
2. **错误处理**: 添加适当的错误处理和用户提示
3. **图片压缩**: 在上传前可以对图片进行压缩以提高上传速度
4. **缓存策略**: 可以考虑对动态列表进行本地缓存
5. **性能优化**: 对于长列表，考虑使用虚拟滚动或分页加载
