<!DOCTYPE html>
<html>
<head>
    <title>WebSocket最终测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>WebSocket最终测试</h1>
    <button onclick="testConnection()">测试连接</button>
    <button onclick="sendMessage()">发送消息</button>
    <button onclick="clearLog()">清空日志</button>
    
    <div id="log" class="log"></div>

    <script>
        let ws = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : (type === 'error' ? 'error' : '');
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function testConnection() {
            log('开始测试WebSocket连接...');
            
            if (ws) {
                ws.close();
            }
            
            ws = new WebSocket('ws://localhost:9001/ws/chat');
            
            ws.onopen = function() {
                log('✓ WebSocket连接成功！', 'success');
            };
            
            ws.onmessage = function(event) {
                log('收到消息: ' + event.data, 'success');
            };
            
            ws.onclose = function(event) {
                log('连接关闭: 代码=' + event.code + ', 原因=' + event.reason, event.code === 1000 ? 'success' : 'error');
            };
            
            ws.onerror = function() {
                log('✗ 连接失败', 'error');
            };
        }
        
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket未连接', 'error');
                return;
            }
            
            const message = '测试消息 ' + new Date().toLocaleTimeString();
            ws.send(message);
            log('发送消息: ' + message);
        }
        
        // 页面加载时自动测试
        window.onload = function() {
            setTimeout(testConnection, 500);
        };
    </script>
</body>
</html>
