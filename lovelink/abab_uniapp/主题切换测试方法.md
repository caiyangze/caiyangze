# 主题切换测试方法

## 最新修复状态 - 存储检查方案

由于 uni.$emit 和 uni.$on 在页面间通信有问题，我改用存储检查的方案。

### 修复策略 v3.0

1. **存储检查** - 使用 uni.setStorageSync 和 uni.getStorageSync 进行数据同步
2. **时间戳检测** - 使用 `themeChangeTime` 时间戳检测主题是否有变化
3. **本地响应式变量** - 每个页面使用自己的 `pageBg` 响应式变量
4. **页面显示检查** - `onShow` 时主动检查存储中的主题变化

### 当前实现 v3.0

每个页面现在使用这个存储检查模式：

```javascript
// 导入
import { currentBackground } from '@/utils/simple-theme.js';

// 本地响应式变量和时间戳
const pageBg = ref('linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
let lastThemeChangeTime = 0;

// 计算属性
const computedBg = computed(() => {
  return pageBg.value;
});

// 检查主题是否有变化
const checkThemeChange = () => {
  try {
    const savedBackground = uni.getStorageSync('currentBackground');
    const themeChangeTime = uni.getStorageSync('themeChangeTime') || 0;

    if (themeChangeTime > lastThemeChangeTime && savedBackground) {
      console.log('页面检测到主题变化:', savedBackground);
      pageBg.value = savedBackground;
      lastThemeChangeTime = themeChangeTime;
    }
  } catch (error) {
    console.error('检查主题变化失败:', error);
  }
};

// 页面显示时检查主题变化
onShow(() => {
  console.log('页面显示，检查主题变化');
  checkThemeChange();
  // 同时同步当前主题作为备用
  pageBg.value = currentBackground.value;
});
```

### 存储机制

在 `simple-theme.js` 的 `switchTheme` 函数中：

```javascript
// 保存到本地存储
uni.setStorageSync('selectedTheme', themeId);
uni.setStorageSync('currentBackground', themes[themeId].background);
uni.setStorageSync('themeChangeTime', Date.now()); // 时间戳用于检测变化
```

## 测试步骤 v3.0

### 第一步：基础测试
1. 打开应用，进入"我的"页面
2. 点击"主题切换"，选择不同的主题（比如"深海蓝调"）
3. 观察个人主页背景是否变化 ✅（这个应该正常）

### 第二步：页面切换测试
1. 在个人主页切换主题后，点击底部导航切换到"首页"
2. 观察首页背景是否与个人主页一致
3. 切换到"广场"页面，观察背景
4. 切换到"消息"页面，观察背景

### 第三步：控制台日志检查
打开开发者工具，查看控制台日志：
- 应该看到"页面显示，检查主题变化"的日志
- 应该看到"页面检测到主题变化: xxx"的日志
- 应该看到"简化主题切换: xxx"的日志
- 应该看到"全局背景已更新: xxx"的日志
- 应该看到"主题已保存: xxx"的日志

### 第四步：存储机制验证
在个人主页切换主题时，应该能看到：
1. "简化主题切换: 主题ID"
2. "全局背景已更新: 背景CSS"
3. "主题已保存: 主题ID 背景CSS"
4. 切换到其他页面时看到 "页面检测到主题变化: 背景CSS"

## 预期结果

如果修复成功：
- ✅ 个人主页主题切换正常（原本就正常）
- ✅ 底部导航栏跟随主题变化（原本就正常）
- ✅ 首页、广场、消息页面在切换进入时显示正确的主题背景

如果仍然有问题：
- ❌ 其他页面背景不变化
- ❌ 控制台有错误信息
- ❌ `currentBackground.value` 没有正确更新

## 调试信息

如果测试失败，请提供以下信息：
1. 控制台的错误信息
2. 在个人主页切换主题时的控制台日志
3. 切换到其他页面时的控制台日志
4. 具体哪个页面没有响应主题变化

## 下一步计划

如果当前方法仍然不工作，我们将：
1. 检查 `currentBackground` 的响应式是否真的有效
2. 尝试使用事件总线的方式
3. 考虑使用 Pinia 或其他状态管理方案
4. 分析您的个人主页为什么能正常工作的真正原因
