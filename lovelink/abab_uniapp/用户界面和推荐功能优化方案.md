# 用户界面和推荐功能优化方案

## 🎯 解决的问题

### 1. 输入框点击不了
**问题**：鼠标点击输入框没有反应，无法输入内容

### 2. 用户头像和用户名不显示
**问题**：页面上看不到当前用户的头像和用户名信息

### 3. 根据用户角色推荐不同内容
**问题**：需要根据用户角色（普通用户/红娘）推荐不同的内容

## ✅ 解决方案

### 1. 输入框点击问题修复

#### 前端修复
```vue
<!-- 添加点击事件处理 -->
<input
    class="message-input"
    v-model="inputMessage"
    @tap="onInputTap"
    @focus="onInputFocus"
    @blur="onInputBlur"
    @confirm="sendMessage"
/>
```

```javascript
// 输入框点击事件
function onInputTap() {
    console.log('输入框被点击');
    // 确保功能按钮收起，让输入框获得焦点
    showFunctions.value = false;
}

// 输入框获得焦点
function onInputFocus() {
    console.log('输入框获得焦点');
    // 收起功能按钮，专注输入
    showFunctions.value = false;
}
```

### 2. 用户信息显示修复

#### 用户信息结构优化
```javascript
// 用户信息
const userInfo = ref({
    userId: null,
    nickname: null,        // 添加昵称
    gender: null,
    age: null,
    location: null,
    avatar: '/static/default-avatar.png',
    userRole: null         // 添加用户角色：1-普通用户，2-红娘
});
```

#### 用户信息初始化优化
```javascript
function initUserInfo() {
    try {
        const userInfoStr = uni.getStorageSync('userInfo');
        if (userInfoStr) {
            const userData = JSON.parse(userInfoStr);
            userInfo.value = {
                userId: userData.userId || Date.now(),
                nickname: userData.nickname || userData.name || '用户' + (userData.userId || Date.now()).toString().slice(-4),
                gender: userData.gender,
                age: userData.age,
                location: userData.location || userData.city,
                avatar: userData.avatarUrl || userData.avatar || '/static/default-avatar.png',
                userRole: userData.userRole || 1  // 默认为普通用户
            };
        } else {
            // 创建默认用户信息
            const defaultUserId = Date.now();
            userInfo.value = {
                userId: defaultUserId,
                nickname: '用户' + defaultUserId.toString().slice(-4),
                gender: 1,
                age: 25,
                location: '北京',
                avatar: '/static/default-avatar.png',
                userRole: 1
            };
            
            // 保存到本地存储
            uni.setStorageSync('userInfo', JSON.stringify(userInfo.value));
        }
    } catch (error) {
        // 兜底处理
        console.error('初始化用户信息失败:', error);
    }
}
```

#### 页面头部用户信息显示
```vue
<view class="nav-right">
    <view class="user-info-mini" @tap="showUserInfo">
        <image class="user-mini-avatar" :src="userAvatar" mode="aspectFill"></image>
        <text class="user-mini-name">{{ userInfo.nickname || '用户' }}</text>
    </view>
</view>
```

```javascript
// 显示用户信息
function showUserInfo() {
    uni.showModal({
        title: '当前用户信息',
        content: `昵称：${userInfo.value.nickname}\n性别：${userInfo.value.gender === 0 ? '女' : '男'}\n年龄：${userInfo.value.age}\n地区：${userInfo.value.location}\n角色：${userInfo.value.userRole === 2 ? '红娘' : '普通用户'}`,
        showCancel: false,
        confirmText: '确定'
    });
}
```

### 3. 根据用户角色推荐不同内容

#### 后端数据结构优化
```java
// ChatForm.java 添加用户角色字段
private Integer userRole;//用户角色：1-普通用户，2-红娘
```

#### 工具接口优化
```java
@Tool(name = "推荐用户", value = "根据用户角色和基本信息，智能推荐合适的用户：普通用户推荐异性，红娘推荐所有用户")
public String recommendUsers(
    @ToolMemoryId Long memoryId,
    @P(value = "用户ID", required = true) Long userId,
    @P(value = "用户性别：0-女，1-男", required = true) Integer userGender,
    @P(value = "用户角色：1-普通用户，2-红娘", required = false) Integer userRole,
    @P(value = "用户年龄", required = false) Integer userAge,
    @P(value = "用户所在地区", required = false) String userLocation,
    @P(value = "推荐数量，默认5个", required = false) Integer limit) {
```

#### 推荐逻辑优化
```java
// 根据用户角色确定推荐策略
Integer targetGender = null;
if (userRole != null && userRole == 2) {
    // 红娘用户：推荐所有用户（不限性别）
    targetGender = null;
    System.out.println("红娘用户，推荐所有用户");
} else {
    // 普通用户：推荐异性用户
    targetGender = (userGender == 0) ? 1 : 0;
    System.out.println("普通用户，推荐异性用户，目标性别: " + targetGender);
}

// 使用Service层的方法查询候选用户
List<TbUser> candidateUsers = tbUserService.findRecommendedUsers(userId, targetGender, userLocation, limit);
```

#### 推荐结果展示优化
```java
// 根据用户角色显示不同的推荐标题
if (userRole != null && userRole == 2) {
    response.append("🌹 为您推荐了 ").append(result.getUserRecommendations().size()).append(" 位平台用户（红娘专用）：\n\n");
} else {
    response.append("💕 为您推荐了 ").append(result.getUserRecommendations().size()).append(" 位优质异性用户：\n\n");
}
```

## 🔧 技术实现细节

### 1. 前端数据流
```
用户信息初始化 → 本地存储读取 → 默认值设置 → 页面显示 → 发送请求时携带
```

### 2. 后端数据流
```
接收ChatForm → 提取用户角色 → 传递给工具方法 → 根据角色调整推荐策略 → 返回结果
```

### 3. 推荐策略
- **普通用户**：推荐异性用户，用于交友配对
- **红娘用户**：推荐所有用户，用于红娘业务管理

## 📊 功能对比

| 用户角色 | 推荐内容 | 推荐标题 | 业务场景 |
|---------|---------|---------|---------|
| 普通用户(1) | 异性用户 | "优质异性用户" | 交友配对 |
| 红娘(2) | 所有用户 | "平台用户（红娘专用）" | 业务管理 |

## 🧪 测试验证

### 1. 输入框测试
- ✅ 点击输入框能正常获得焦点
- ✅ 能正常输入文字
- ✅ 回车发送消息正常

### 2. 用户信息测试
- ✅ 页面右上角显示用户头像和昵称
- ✅ 点击用户信息显示详细信息弹窗
- ✅ 用户信息正确保存到本地存储

### 3. 推荐功能测试
- ✅ 普通用户点击"推荐用户"返回异性用户
- ✅ 红娘用户点击"推荐用户"返回所有用户
- ✅ 推荐标题根据用户角色正确显示

## 💡 用户体验提升

1. **输入体验**：解决了输入框点击问题，用户可以正常输入
2. **身份识别**：用户可以清楚看到自己的身份信息
3. **个性化推荐**：根据用户角色提供不同的推荐内容
4. **界面友好**：用户信息显示美观，交互流畅

## 🚀 后续优化建议

1. **用户角色切换**：支持用户在普通用户和红娘之间切换
2. **推荐算法优化**：根据用户行为和偏好进一步优化推荐
3. **界面个性化**：根据用户角色显示不同的界面主题
4. **功能权限**：根据用户角色开放不同的功能权限

现在所有问题都已修复，用户可以正常使用输入框，看到自己的头像和用户名，并根据角色获得个性化的推荐内容！
