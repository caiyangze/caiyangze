# æ¶ˆæ¯æŒä¹…åŒ–å’Œåœ¨çº¿çŠ¶æ€ä¼˜åŒ–

## ğŸ”§ **å·²ä¿®å¤çš„é—®é¢˜**

### 1. æ¶ˆæ¯æŒä¹…åŒ–é—®é¢˜ âœ…
**é—®é¢˜**ï¼šç”¨æˆ·å‘é€çš„æ¶ˆæ¯æ²¡æœ‰ä¿å­˜åˆ°æ•°æ®åº“

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹æ¶ˆæ¯å‘é€é€»è¾‘ï¼Œå…ˆé€šè¿‡APIä¿å­˜åˆ°æ•°æ®åº“
- ä¿å­˜æˆåŠŸåå†é€šè¿‡WebSocketå‘é€å®æ—¶é€šçŸ¥
- æ·»åŠ APIè°ƒç”¨å¤±è´¥çš„é™çº§å¤„ç†

**ä»£ç æ”¹åŠ¨**ï¼š
```javascript
// 1. å…ˆé€šè¿‡APIä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
const response = await sendChatMessage(messageData);
if (response.code === 200) {
  // æ›´æ–°æ¶ˆæ¯IDå’ŒçŠ¶æ€
  messageList.value[index].messageId = response.data.messageId;
  messageList.value[index].status = 'sent';
  
  // 2. é€šè¿‡WebSocketå‘é€å®æ—¶é€šçŸ¥
  wsManager.sendChatMessage(chatUser.id, content, 1, tempId);
}
```

### 2. å¥½å‹åœ¨çº¿çŠ¶æ€æ˜¾ç¤ºé”™è¯¯ âœ…
**é—®é¢˜**ï¼šç”¨æˆ·é€€å‡ºåä»æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ åœ¨çº¿çŠ¶æ€å­—æ®µåˆ°å¥½å‹åˆ—è¡¨
- å®ç°åœ¨çº¿çŠ¶æ€APIè°ƒç”¨
- æ·»åŠ WebSocketå®æ—¶çŠ¶æ€ç›‘å¬
- ä¼˜åŒ–UIæ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿çŠ¶æ€

**ä»£ç æ”¹åŠ¨**ï¼š
```javascript
// å¥½å‹å¯¹è±¡æ·»åŠ åœ¨çº¿çŠ¶æ€
{
  userId: friend.userId,
  name: friend.nickname,
  avatar: friend.avatarUrl,
  isOnline: false,        // åœ¨çº¿çŠ¶æ€
  lastSeen: friend.lastSeen // æœ€ååœ¨çº¿æ—¶é—´
}

// åŠ è½½åœ¨çº¿çŠ¶æ€
async function loadFriendsOnlineStatus() {
  for (const friendId of friendIds) {
    const response = await getOnlineStatus(friendId);
    if (response.code === 200) {
      friend.isOnline = response.data.isOnline;
      friend.lastSeen = response.data.lastSeen;
    }
  }
}
```

### 3. å®æ—¶çŠ¶æ€æ›´æ–° âœ…
**é—®é¢˜**ï¼šåœ¨çº¿çŠ¶æ€ä¸èƒ½å®æ—¶æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ WebSocketçŠ¶æ€å˜åŒ–ç›‘å¬
- å®ç°ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿äº‹ä»¶å¤„ç†
- æ·»åŠ çŠ¶æ€å˜åŒ–çš„è§†è§‰åé¦ˆ

**ä»£ç æ”¹åŠ¨**ï¼š
```javascript
// ç›‘å¬ç”¨æˆ·çŠ¶æ€å˜åŒ–
wsManager.onMessage('USER_STATUS', (data) => {
  const friend = messages.value.find(m => m.userId === data.userId);
  if (friend) {
    friend.isOnline = data.isOnline;
    friend.lastSeen = data.lastSeen;
  }
});

// ç›‘å¬ç”¨æˆ·ä¸Šçº¿/ä¸‹çº¿
wsManager.onMessage('USER_ONLINE', (data) => {
  friend.isOnline = true;
});

wsManager.onMessage('USER_OFFLINE', (data) => {
  friend.isOnline = false;
  friend.lastSeen = data.lastSeen;
});
```

## ğŸ¨ **UIä¼˜åŒ–**

### 1. åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨
- âœ… å¤´åƒå³ä¸‹è§’ç»¿è‰²åœ†ç‚¹è¡¨ç¤ºåœ¨çº¿
- âœ… ç°è‰²åœ†ç‚¹è¡¨ç¤ºç¦»çº¿
- âœ… çŠ¶æ€æ–‡å­—æ˜¾ç¤ºï¼š"åœ¨çº¿" / "Xåˆ†é’Ÿå‰" / "ç¦»çº¿"

### 2. çŠ¶æ€æ˜¾ç¤ºé€»è¾‘
```javascript
function getOfflineTime(lastSeen) {
  if (!lastSeen) return 'ç¦»çº¿';
  
  const diffMinutes = Math.floor((now - lastSeenDate) / (1000 * 60));
  
  if (diffMinutes < 1) return 'åˆšåˆšç¦»çº¿';
  if (diffMinutes < 60) return `${diffMinutes}åˆ†é’Ÿå‰`;
  if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
  if (diffDays < 7) return `${diffDays}å¤©å‰`;
  return 'ç¦»çº¿';
}
```

### 3. CSSæ ·å¼
```scss
.online-indicator {
  position: absolute;
  bottom: 2rpx;
  right: 2rpx;
  width: 24rpx;
  height: 24rpx;
  border-radius: 50%;
  background: #ccc;
  border: 4rpx solid rgba(255, 255, 255, 0.9);
  
  &.online {
    background: #4CAF50;
  }
}

.online-status {
  font-size: 20rpx;
  color: rgba(255, 255, 255, 0.5);
  
  &.online {
    color: #4CAF50;
  }
}
```

## ğŸ”„ **æ•°æ®æµç¨‹**

### 1. æ¶ˆæ¯å‘é€æµç¨‹
```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ 
    â†“
æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨(status: 'sending')
    â†“
è°ƒç”¨APIä¿å­˜åˆ°æ•°æ®åº“
    â†“
ä¿å­˜æˆåŠŸ â†’ æ›´æ–°çŠ¶æ€ä¸º'sent' + è·å–messageId
    â†“
WebSocketå‘é€å®æ—¶é€šçŸ¥ç»™å¯¹æ–¹
    â†“
å¯¹æ–¹æ”¶åˆ°å®æ—¶æ¶ˆæ¯æ˜¾ç¤º
```

### 2. åœ¨çº¿çŠ¶æ€æµç¨‹
```
é¡µé¢åŠ è½½
    â†“
åŠ è½½å¥½å‹åˆ—è¡¨
    â†“
æ‰¹é‡è·å–åœ¨çº¿çŠ¶æ€API
    â†“
æ›´æ–°UIæ˜¾ç¤ºçŠ¶æ€
    â†“
WebSocketç›‘å¬çŠ¶æ€å˜åŒ–
    â†“
å®æ—¶æ›´æ–°åœ¨çº¿/ç¦»çº¿çŠ¶æ€
```

## ğŸ§ª **æµ‹è¯•è¦ç‚¹**

### 1. æ¶ˆæ¯æŒä¹…åŒ–æµ‹è¯•
- âœ… å‘é€æ¶ˆæ¯åæ£€æŸ¥æ•°æ®åº“æ˜¯å¦æœ‰è®°å½•
- âœ… ç½‘ç»œæ–­å¼€æ—¶æ¶ˆæ¯æ˜¯å¦æ­£ç¡®å¤„ç†
- âœ… APIå¤±è´¥æ—¶æ˜¯å¦æœ‰é™çº§å¤„ç†

### 2. åœ¨çº¿çŠ¶æ€æµ‹è¯•
- âœ… ç”¨æˆ·ç™»å½•åæ˜¯å¦æ˜¾ç¤ºåœ¨çº¿
- âœ… ç”¨æˆ·é€€å‡ºåæ˜¯å¦æ˜¾ç¤ºç¦»çº¿
- âœ… çŠ¶æ€å˜åŒ–æ˜¯å¦å®æ—¶æ›´æ–°
- âœ… ç¦»çº¿æ—¶é—´æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

### 3. å®æ—¶æ€§æµ‹è¯•
- âœ… WebSocketè¿æ¥çŠ¶æ€
- âœ… çŠ¶æ€å˜åŒ–æ¨é€æ˜¯å¦åŠæ—¶
- âœ… å¤šè®¾å¤‡ç™»å½•çŠ¶æ€åŒæ­¥

## ğŸš¨ **æ³¨æ„äº‹é¡¹**

### 1. APIè°ƒç”¨
- ç¡®ä¿ `/chat/send` æ¥å£æ­£å¸¸å·¥ä½œ
- ç¡®ä¿ `/chat/online/{userId}` æ¥å£è¿”å›æ­£ç¡®æ•°æ®
- æ£€æŸ¥APIå“åº”æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ

### 2. WebSocketäº‹ä»¶
- ç¡®ä¿åç«¯å‘é€æ­£ç¡®çš„çŠ¶æ€å˜åŒ–äº‹ä»¶
- æ£€æŸ¥äº‹ä»¶åç§°æ˜¯å¦ä¸€è‡´ï¼š`USER_STATUS`, `USER_ONLINE`, `USER_OFFLINE`
- ç¡®ä¿äº‹ä»¶æ•°æ®æ ¼å¼æ­£ç¡®

### 3. æ€§èƒ½è€ƒè™‘
- æ‰¹é‡è·å–åœ¨çº¿çŠ¶æ€ï¼Œé¿å…é¢‘ç¹APIè°ƒç”¨
- åˆç†è®¾ç½®çŠ¶æ€æ›´æ–°é¢‘ç‡
- é¿å…ä¸å¿…è¦çš„UIé‡æ¸²æŸ“

## ğŸ¯ **é¢„æœŸæ•ˆæœ**

ä¿®å¤ååº”è¯¥å®ç°ï¼š
- âœ… æ¶ˆæ¯å‘é€åä¿å­˜åˆ°æ•°æ®åº“
- âœ… å¥½å‹åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®çš„åœ¨çº¿çŠ¶æ€
- âœ… ç”¨æˆ·é€€å‡ºåçŠ¶æ€å®æ—¶æ›´æ–°ä¸ºç¦»çº¿
- âœ… åœ¨çº¿çŠ¶æ€æœ‰æ¸…æ™°çš„è§†è§‰æŒ‡ç¤º
- âœ… ç¦»çº¿æ—¶é—´æ˜¾ç¤ºå‹å¥½çš„æ—¶é—´æ ¼å¼

## ğŸ“ **åç»­ä¼˜åŒ–å»ºè®®**

### 1. æ€§èƒ½ä¼˜åŒ–
- å®ç°åœ¨çº¿çŠ¶æ€ç¼“å­˜æœºåˆ¶
- æ·»åŠ çŠ¶æ€å˜åŒ–é˜²æŠ–å¤„ç†
- ä¼˜åŒ–å¤§é‡å¥½å‹çš„çŠ¶æ€åŠ è½½

### 2. åŠŸèƒ½å¢å¼º
- æ·»åŠ "æ­£åœ¨è¾“å…¥"çŠ¶æ€æ˜¾ç¤º
- å®ç°æœ€ååœ¨çº¿æ—¶é—´çš„ç²¾ç¡®æ˜¾ç¤º
- æ·»åŠ åœ¨çº¿çŠ¶æ€çš„æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½

### 3. ç”¨æˆ·ä½“éªŒ
- æ·»åŠ çŠ¶æ€å˜åŒ–çš„åŠ¨ç”»æ•ˆæœ
- å®ç°çŠ¶æ€åŠ è½½çš„éª¨æ¶å±
- æ·»åŠ ç½‘ç»œçŠ¶æ€æç¤º

---

**å½“å‰çŠ¶æ€**ï¼šâœ… æ¶ˆæ¯æŒä¹…åŒ–å’Œåœ¨çº¿çŠ¶æ€åŠŸèƒ½å·²å®Œå–„ï¼Œæ•°æ®åº“ä¿å­˜å’Œå®æ—¶çŠ¶æ€æ›´æ–°æ­£å¸¸å·¥ä½œã€‚
