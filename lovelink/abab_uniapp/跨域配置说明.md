# 跨域配置说明

## 🎯 什么是跨域问题？

当前端和后端运行在不同的端口时，浏览器会阻止前端访问后端API，这就是跨域问题。

### 当前情况：
- **后端服务**：运行在 `http://localhost:8084`
- **前端应用**：运行在 `http://localhost:5173` （或其他端口）
- **问题**：前端无法直接访问后端API

## 🔧 解决方案

### 1. 后端跨域配置 (已修复)

在 `langchain4j-ai/src/main/java/com/zhentao/config/CorsConfig.java` 中：

```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                // 允许这些前端地址访问后端
                .allowedOrigins(
                    "http://localhost:5173",    // 你的前端地址
                    "http://127.0.0.1:5173",
                    "http://localhost:8080",    // 其他可能的前端端口
                    "http://127.0.0.1:8080"
                )
                // 允许的HTTP方法
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                // 允许的请求头
                .allowedHeaders("*")
                // 不使用凭证（避免复杂的跨域问题）
                .allowCredentials(false);
    }
}
```

### 2. 前端请求配置 (已修复)

在前端发送请求时：

```javascript
const response = await fetch('http://localhost:8084/xiaozhi/chat', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data),
    credentials: 'omit'  // 不发送凭证，避免跨域问题
});
```

## 📋 端口说明

### 后端端口：8084
- 这是你的Spring Boot应用运行的端口
- API地址：`http://localhost:8084/xiaozhi/chat`

### 前端端口：5173 (或其他)
- 这是你的前端应用运行的端口
- 常见的前端端口：
  - `5173` - Vite 默认端口
  - `8080` - uni-app H5 常用端口
  - `3000` - React/Next.js 默认端口

## 🧪 测试步骤

### 1. 重启后端服务
```bash
cd langchain4j-ai
mvn spring-boot:run
```

### 2. 确认后端启动成功
看到这样的日志表示成功：
```
✓ 服务端口: 8084
✓ 跨域配置: 已启用全局CORS支持
🚀 AI红娘服务已启动，访问地址: http://localhost:8084/xiaozhi/chat
```

### 3. 测试前端连接
访问：`/pages/test/simple-chat`
- 点击"测试连接"按钮
- 如果显示"后端连接正常"，说明跨域问题已解决

### 4. 测试AI聊天
- 输入测试消息
- 点击"发送"或"快速测试"
- 查看是否能收到AI回复

## ❌ 常见错误

### 错误1：CORS policy blocked
```
Access to fetch at 'http://localhost:8084/xiaozhi/chat' from origin 'http://localhost:5173' has been blocked by CORS policy
```
**解决**：确认后端跨域配置包含了你的前端端口

### 错误2：allowCredentials 错误
```
When allowCredentials is true, allowedOrigins cannot contain the special value "*"
```
**解决**：已修复，设置 `allowCredentials(false)`

### 错误3：500 Internal Server Error
这通常不是跨域问题，而是后端逻辑错误，需要查看后端日志

## 🔍 调试方法

### 1. 检查浏览器控制台
- 按F12打开开发者工具
- 查看Console面板的错误信息
- 查看Network面板的请求状态

### 2. 检查后端日志
- 查看控制台输出
- 确认没有跨域相关的错误

### 3. 手动测试API
使用浏览器直接访问：
```
http://localhost:8084/xiaozhi/chat
```
如果看到405错误（Method Not Allowed），说明后端正常运行

## 💡 重要提示

1. **每次修改跨域配置后，必须重启后端服务**
2. **前端端口变化时，需要更新后端的跨域配置**
3. **如果还有问题，可以临时设置 `allowedOrigins("*")` 和 `allowCredentials(false)` 进行测试**

## 🆘 紧急解决方案

如果还是不行，可以临时使用这个配置：

```java
@Override
public void addCorsMappings(CorsRegistry registry) {
    registry.addMapping("/**")
            .allowedOrigins("*")
            .allowedMethods("*")
            .allowedHeaders("*")
            .allowCredentials(false);
}
```

这个配置允许所有来源访问，仅用于开发测试！
