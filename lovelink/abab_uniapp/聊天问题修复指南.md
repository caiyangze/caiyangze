# 聊天问题修复指南

## 🔍 **问题诊断**

### 1. 消息布局问题
**现象**：自己发送的消息头像在左边，消息在右边
**原因**：CSS样式或消息数据的 `isSelf` 属性设置错误

**检查步骤**：
```javascript
// 1. 检查消息对象的isSelf属性
console.log('发送消息:', newMessage);
// 应该显示: { isSelf: true, ... }

// 2. 检查当前用户ID是否正确
console.log('当前用户信息:', currentUser);
// 应该显示: { id: 1001, avatar: "...", nickname: "我" }
```

### 2. 发送失败问题
**现象**：消息显示"重发"状态
**原因**：WebSocket连接失败或发送失败

**检查步骤**：
```javascript
// 1. 检查WebSocket连接状态
console.log('WebSocket连接状态:', wsManager.isConnected);

// 2. 检查token是否存在
const token = uni.getStorageSync('token');
console.log('Token:', token);

// 3. 检查用户信息
const userInfo = uni.getStorageSync('userInfo');
console.log('用户信息:', userInfo);
```

### 3. 在线状态问题
**现象**：显示"离线"状态
**原因**：WebSocket连接失败或在线状态检测失败

## 🛠️ **修复方案**

### 1. 消息布局修复
确保CSS样式正确：
```scss
.message-item {
  &.message-self {
    .message-content {
      flex-direction: row-reverse; // 自己的消息：头像在右，消息在左
      
      .message-bubble {
        margin-right: 0;
        margin-left: 20rpx;
      }
    }
  }
}
```

### 2. WebSocket连接修复
```javascript
// 确保在发送消息前检查连接状态
if (!wsManager.isConnected) {
  // 尝试重新连接
  const token = uni.getStorageSync('token');
  await wsManager.connect(token);
}
```

### 3. 用户信息修复
```javascript
// 确保用户信息正确获取
function getCurrentUserInfo() {
  const userInfo = uni.getStorageSync('userInfo');
  if (userInfo) {
    currentUser.id = userInfo.userId || userInfo.id;
    currentUser.avatar = userInfo.avatarUrl || userInfo.avatar;
  } else {
    // 设置默认值
    currentUser.id = 1001;
    currentUser.avatar = '/static/message/default-avatar.png';
  }
}
```

## 🧪 **测试步骤**

### 1. 基础功能测试
1. **打开聊天页面**
   - 检查控制台是否有错误
   - 检查WebSocket连接状态
   - 检查用户信息是否正确

2. **发送消息测试**
   - 发送一条消息
   - 检查消息布局是否正确（自己的消息在右边）
   - 检查消息状态变化：发送中 → 已送达

3. **在线状态测试**
   - 检查顶部是否显示"在线"状态
   - 断开网络，检查是否显示"离线"

### 2. 错误处理测试
1. **网络断开测试**
   - 断开网络
   - 发送消息
   - 检查是否显示"重发"按钮
   - 恢复网络，点击重发

2. **WebSocket重连测试**
   - 关闭WebSocket连接
   - 发送消息
   - 检查是否自动重连

## 🔧 **调试技巧**

### 1. 控制台调试
在浏览器开发者工具中查看：
```javascript
// 检查WebSocket状态
console.log('WebSocket状态:', wsManager.isConnected);

// 检查消息列表
console.log('消息列表:', messageList.value);

// 检查当前用户
console.log('当前用户:', currentUser);

// 检查聊天对象
console.log('聊天对象:', chatUser);
```

### 2. 网络调试
1. 打开开发者工具 → Network 标签
2. 查看WebSocket连接状态
3. 检查消息发送和接收

### 3. 存储调试
```javascript
// 检查本地存储
console.log('Token:', uni.getStorageSync('token'));
console.log('用户信息:', uni.getStorageSync('userInfo'));
```

## 🚨 **常见问题解决**

### 1. 消息布局错误
**解决方案**：
- 检查 `isSelf` 属性是否正确
- 检查CSS样式是否正确应用
- 确保 `currentUser.id` 正确设置

### 2. 发送失败
**解决方案**：
- 检查WebSocket连接状态
- 检查token是否有效
- 检查网络连接
- 查看服务器日志

### 3. 在线状态错误
**解决方案**：
- 检查WebSocket连接
- 检查服务器在线状态接口
- 确保正确监听状态变化事件

## 📝 **注意事项**

1. **用户ID类型**：确保用户ID类型一致（数字或字符串）
2. **WebSocket连接**：确保在发送消息前WebSocket已连接
3. **错误处理**：添加充分的错误处理和用户提示
4. **状态同步**：确保消息状态正确同步

## 🎯 **预期效果**

修复后应该实现：
- ✅ 自己的消息在右边，头像在右边
- ✅ 对方的消息在左边，头像在左边  
- ✅ 消息状态正确显示：发送中 → 已送达
- ✅ 在线状态正确显示
- ✅ 发送失败时可以重发
- ✅ WebSocket断线自动重连

---

**如果问题仍然存在，请检查：**
1. 服务器WebSocket服务是否正常运行
2. 网络连接是否稳定
3. token是否有效
4. 用户信息是否正确存储
