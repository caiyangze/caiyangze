import{N as e,_ as t,X as s,s as a,T as r,V as i,d as u,w as c,i as l,f as o,h as n,j as h,l as d,m as f,F as g,t as m,k as p,q as T,v,A as k,K as y}from"./index-BpPI9udZ.js";const b=t({data:()=>({currentTab:0,tabs:[{name:"可领取",key:"available"},{name:"我的券",key:"my"}],voucherList:[],loading:!1,refreshing:!1,hasMore:!0,pageNum:1,pageSize:10}),onLoad(){this.loadVoucherList()},methods:{goBack(){s()},switchTab(e){this.currentTab=e,this.resetList(),this.loadVoucherList()},resetList(){this.voucherList=[],this.pageNum=1,this.hasMore=!0},async loadVoucherList(){if(!this.loading){this.loading=!0;try{let t;if(t=0===this.currentTab?await function(t={}){return e.request({url:"/voucher/list",method:"POST",data:Object.assign({pageNum:t.pageNum||1,pageSize:t.pageSize||10},t),hideErrorToast:!0})}({pageNum:this.pageNum,pageSize:this.pageSize}):await function(t={}){return e.request({url:"/voucher/getMyVoucherList",method:"POST",data:{pageNum:t.pageNum||1,pageSize:t.pageSize||10,status:t.status,...t},hideErrorToast:!0})}({pageNum:this.pageNum,pageSize:this.pageSize}),200===t.code){const e=t.data;let s=e.records||e||[];1===this.currentTab&&(s=s.map((e=>({...e.voucher||{},orderId:e.id,orderStatus:e.status,payTime:e.payTime,useTime:e.useTime,createTime:e.createTime,voucherStatus:this.getVoucherStatusFromOrder(e.status)})))),1===this.pageNum?this.voucherList=s:this.voucherList.push(...s),e.records?this.hasMore=e.current<e.pages:this.hasMore=s.length>=this.pageSize}}catch(t){console.error("加载优惠券列表失败:",t);let e="加载失败";t&&t.message?e=t.message:t&&"string"==typeof t?e=t:t&&t.data&&t.data.message&&(e=t.data.message),a({title:e,icon:"none"})}finally{this.loading=!1,this.refreshing=!1}}},onRefresh(){this.refreshing=!0,this.resetList(),this.loadVoucherList()},loadMore(){this.hasMore&&!this.loading&&(this.pageNum++,this.loadVoucherList())},async handleVoucherAction(e){0===this.currentTab&&await this.seckillVoucher(e)},async seckillVoucher(t){try{r({title:"领取中..."});const u=await(s=t.id,e.request({url:`/voucher/seckill?voucherId=${s}`,method:"POST",hideErrorToast:!0}));200===u.code?(a({title:"领取成功",icon:"success"}),this.onRefresh()):a({title:u.message||"领取失败",icon:"none"})}catch(u){console.error("领取优惠券失败:",u);let e="领取失败";u&&u.message?e=u.message:u&&"string"==typeof u?e=u:u&&u.data&&u.data.message&&(e=u.data.message),a({title:e,icon:"none",duration:3e3})}finally{i()}var s},getVoucherClass(e){const t=[];return 1===e.type&&t.push("seckill-voucher"),this.isVoucherExpired(e)&&t.push("expired"),this.isVoucherUsed(e)&&t.push("used"),t.join(" ")},getVoucherTypeText:e=>({0:"普通券",1:"秒杀券",2:"代金券"}[e]||"优惠券"),getTimeText(e){if(!e)return"";const t=new Date,s=new Date(e.beginTime),a=new Date(e.endTime);return t<s?`${this.formatTime(s)} 开始`:t>a?"已结束":`${this.formatTime(a)} 结束`},getBtnClass(e){if(1===this.currentTab&&e.voucherStatus)switch(e.voucherStatus){case"unused":return"available";case"used":case"cancelled":case"refunded":default:return"disabled";case"unpaid":case"refunding":return"warning"}return this.isVoucherDisabled(e)?"disabled":1===e.type?"seckill":"normal"},getBtnText(e){if(1===this.currentTab){if(e.voucherStatus)switch(e.voucherStatus){case"unpaid":return"未支付";case"unused":return"未使用";case"used":return"已使用";case"cancelled":return"已取消";case"refunding":return"退款中";case"refunded":return"已退款";default:return"未知状态"}return this.isVoucherUsed(e)?"已使用":this.isVoucherExpired(e)?"已过期":"未使用"}return this.isVoucherExpired(e)?"已过期":e.seckilVoucher&&e.seckilVoucher.stock<=0?"已抢完":1===e.type?"立即抢购":"立即领取"},isVoucherDisabled(e){return 1===this.currentTab||(this.isVoucherExpired(e)||e.seckilVoucher&&e.seckilVoucher.stock<=0)},isVoucherExpired(e){if(!e.seckilVoucher)return!1;return new Date>new Date(e.seckilVoucher.endTime)},isVoucherUsed(e){return 1===this.currentTab&&e.voucherStatus?"used"===e.voucherStatus:3===e.status},getVoucherStatusFromOrder(e){switch(e){case 1:return"unpaid";case 2:return"unused";case 3:return"used";case 4:return"cancelled";case 5:return"refunding";case 6:return"refunded";default:return"unknown"}},formatTime(e){const t=new Date(e);return`${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}}},[["render",function(e,t,s,a,r,i){const b=T,_=l,V=y,S=v;return o(),u(_,{class:"voucher-page"},{default:c((()=>[n(_,{class:"nav-bar"},{default:c((()=>[n(_,{class:"nav-left",onClick:i.goBack},{default:c((()=>[n(b,{class:"nav-icon"},{default:c((()=>[h("←")])),_:1})])),_:1},8,["onClick"]),n(b,{class:"nav-title"},{default:c((()=>[h("优惠券中心")])),_:1}),n(_,{class:"nav-right"})])),_:1}),n(_,{class:"tab-bar"},{default:c((()=>[(o(!0),d(g,null,f(r.tabs,((e,t)=>(o(),u(_,{key:t,class:k(["tab-item",{active:r.currentTab===t}]),onClick:e=>i.switchTab(t)},{default:c((()=>[n(b,{class:"tab-text"},{default:c((()=>[h(m(e.name),1)])),_:2},1024),r.currentTab===t?(o(),u(_,{key:0,class:"tab-indicator"})):p("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1}),n(S,{"scroll-y":"",class:"voucher-list",onScrolltolower:i.loadMore,"refresher-enabled":"",onRefresherrefresh:i.onRefresh,"refresher-triggered":r.refreshing},{default:c((()=>[n(_,{class:"voucher-container"},{default:c((()=>[(o(!0),d(g,null,f(r.voucherList,((e,t)=>(o(),u(_,{key:e.id,class:k(["voucher-card",i.getVoucherClass(e)])},{default:c((()=>[n(_,{class:"voucher-main"},{default:c((()=>[n(_,{class:"voucher-left"},{default:c((()=>[n(_,{class:"voucher-value"},{default:c((()=>[n(b,{class:"value-number"},{default:c((()=>[h(m(e.actualValue),1)])),_:2},1024),n(b,{class:"value-unit"},{default:c((()=>[h("币")])),_:1})])),_:2},1024),n(b,{class:"voucher-type"},{default:c((()=>[h(m(i.getVoucherTypeText(e.type)),1)])),_:2},1024)])),_:2},1024),n(_,{class:"voucher-divider"}),n(_,{class:"voucher-right"},{default:c((()=>[n(_,{class:"voucher-info"},{default:c((()=>[n(b,{class:"voucher-title"},{default:c((()=>[h(m(e.title),1)])),_:2},1024),n(b,{class:"voucher-subtitle"},{default:c((()=>[h(m(e.subTitle),1)])),_:2},1024),e.seckilVoucher&&0===r.currentTab?(o(),u(_,{key:0,class:"seckill-info"},{default:c((()=>[n(b,{class:"stock-text"},{default:c((()=>[h("剩余: "+m(e.seckilVoucher.stock)+"张",1)])),_:2},1024),n(b,{class:"time-text"},{default:c((()=>[h(m(i.getTimeText(e.seckilVoucher)),1)])),_:2},1024)])),_:2},1024)):p("",!0),1===r.currentTab?(o(),u(_,{key:1,class:"my-voucher-info"},{default:c((()=>[e.payTime?(o(),u(b,{key:0,class:"info-text"},{default:c((()=>[h("获取时间: "+m(i.formatTime(e.payTime)),1)])),_:2},1024)):p("",!0),e.useTime?(o(),u(b,{key:1,class:"info-text"},{default:c((()=>[h("使用时间: "+m(i.formatTime(e.useTime)),1)])),_:2},1024)):p("",!0),e.orderId?(o(),u(b,{key:2,class:"info-text"},{default:c((()=>[h("订单号: "+m(e.orderId),1)])),_:2},1024)):p("",!0)])),_:2},1024)):p("",!0)])),_:2},1024),n(V,{class:k(["voucher-btn",i.getBtnClass(e)]),onClick:t=>i.handleVoucherAction(e),disabled:i.isVoucherDisabled(e)},{default:c((()=>[h(m(i.getBtnText(e)),1)])),_:2},1032,["class","onClick","disabled"])])),_:2},1024)])),_:2},1024)])),_:2},1032,["class"])))),128)),0!==r.voucherList.length||r.loading?p("",!0):(o(),u(_,{key:0,class:"empty-state"},{default:c((()=>[n(b,{class:"empty-icon"},{default:c((()=>[h("🎫")])),_:1}),n(b,{class:"empty-text"},{default:c((()=>[h("暂无优惠券")])),_:1}),n(b,{class:"empty-desc"},{default:c((()=>[h(m(0===r.currentTab?"暂时没有可领取的优惠券":"您还没有优惠券"),1)])),_:1})])),_:1})),r.loading?(o(),u(_,{key:1,class:"loading-state"},{default:c((()=>[n(b,null,{default:c((()=>[h("加载中...")])),_:1})])),_:1})):p("",!0),r.hasMore&&r.voucherList.length>0?(o(),u(_,{key:2,class:"load-more"},{default:c((()=>[n(b,null,{default:c((()=>[h("上拉加载更多")])),_:1})])),_:1})):p("",!0)])),_:1})])),_:1},8,["onScrolltolower","onRefresherrefresh","refresher-triggered"])])),_:1})}],["__scopeId","data-v-8c820d68"]]);export{b as default};
