function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/api-user-auth.CC_RESsW.js","assets/index-BpPI9udZ.js","assets/index-DMIaa8Q1.css"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{_ as e,r as a,a as s,o as t,Q as o,g as n,b as l,O as c,Y as i,s as r,G as u,d,w as g,Z as m,i as f,f as v,h as p,j as I,k as _,t as k,A as y,l as h,m as S,F as T,R as b,X as w,I as C,$ as A,q as U,u as x,v as D,M as E,D as W}from"./index-BpPI9udZ.js";import{o as R}from"./uni-app.es.BvOIZWhW.js";import{getChatHistory as F,markMessageAsRead as M,sendMessage as j}from"./api-chat.BF5K77Hj.js";import{w as P}from"./websocket.DvBY1wJ6.js";const L=e({__name:"chat",props:{conversationId:String,userId:String,name:String,avatar:String},setup(e){const L=e,O=a({id:L.userId,name:decodeURIComponent(L.name||""),avatar:decodeURIComponent(L.avatar||"/static/message/default-avatar.png")}),N=a({id:null,avatar:"/static/message/default-avatar.png"}),V=s([]),z=s(""),B=s(0),G=s(""),$=s(!1),q=s(!1),H=s(!1),Q=s(!1),X=s(1),Y=s(20),Z=s(!0),J=s(!1),K=s(null);function ee(){N.id=1001,N.avatar="/static/message/default-avatar.png",N.nickname="我",Q.value=!0,console.log("已设置默认用户信息")}async function ae(e=1){try{const a=o(),s=a[a.length-1],t=s.options.conversationId;if(!t||"new"===t)return void console.log("新会话，无历史记录");1===e?V.value=[]:q.value=!0;const n=await F(t,e,Y.value);if(200===n.code){const a=n.data.map((e=>({...e,isSelf:e.senderId==N.id,status:e.senderId==N.id?"sent":"received"})));1===e?(V.value=a.reverse(),i((()=>{Ie()})),setTimeout((()=>{Ie()}),200),setTimeout((()=>{Ie()}),500)):V.value=[...a.reverse(),...V.value],Z.value=a.length===Y.value}}catch(a){console.error("加载聊天记录失败:",a),r({title:"加载失败",icon:"none"})}finally{q.value=!1}}function se(){!q.value&&Z.value&&(X.value++,ae(X.value))}function te(){const e=z.value.trim();if(!e)return;const a=Date.now(),s={tempId:a,content:e,messageType:1,isSelf:!0,status:"sending",createdAt:(new Date).toISOString(),senderId:N.id,senderAvatar:N.avatar};if(console.log("发送消息:",s),console.log("当前用户头像:",N.avatar),V.value.push(s),z.value="",i((()=>{Ie()})),setTimeout((()=>{Ie()}),100),setTimeout((()=>{Ie()}),300),P.isConnected)t();else{console.warn("WebSocket未连接，尝试重新连接...");const e=n("token");e?P.connect(e).then((()=>{console.log("重连成功，重新发送消息"),t()})).catch((e=>{console.error("重连失败:",e),o()})):(console.error("没有token，无法连接WebSocket"),o())}async function t(){try{const s={receiverId:O.id,content:e,messageType:1};console.log("保存消息到数据库:",s);const t=await j(s);if(200===t.code){console.log("消息保存成功:",t.data);const s=V.value.findIndex((e=>e.tempId===a));s>-1&&(V.value[s].messageId=t.data.messageId,V.value[s].status="sent");P.sendChatMessage(O.id,e,1,a)?console.log("WebSocket实时通知发送成功"):console.warn("WebSocket实时通知发送失败，但消息已保存")}else console.error("消息保存失败:",t),o()}catch(s){console.error("发送消息API调用失败:",s),console.log("尝试仅通过WebSocket发送...");P.sendChatMessage(O.id,e,1,a)?(console.log("WebSocket发送成功，但未保存到数据库"),setTimeout((()=>{const e=V.value.findIndex((e=>e.tempId===a));e>-1&&"sending"===V.value[e].status&&(V.value[e].status="sent",console.log("消息超时自动标记为已发送（可能未保存到数据库）"))}),3e3)):o()}}function o(){console.error("WebSocket发送失败");const e=V.value.findIndex((e=>e.tempId===a));e>-1&&(V.value[e].status="failed"),r({title:"发送失败，请重试",icon:"none"})}}function oe(e){P.sendChatMessage(O.id,e.content,e.messageType,e.tempId)?(console.log("重发成功，等待服务器确认..."),setTimeout((()=>{"sending"===e.status&&(e.status="sent",console.log("重发消息超时自动标记为已发送"))}),5e3)):(e.status="failed",r({title:"重发失败",icon:"none"}))}function ne(e){console.log("头像加载成功:",e.target.src),Q.value=!1}function le(e){console.log("自己头像加载失败:",e.target.src),console.log("错误详情:",e),Q.value=!0}function ce(e){console.log("对方头像加载失败:",e.target.src),console.log("错误详情:",e),e.target.src="/static/message/default-avatar.png"}function ie(){J.value=!0}function re(){J.value=!1}function ue(){K.value&&clearTimeout(K.value),P.sendTyping(O.id),K.value=setTimeout((()=>{}),1e3)}function de(){b({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{console.log("选择图片:",e)}})}function ge(e){W({urls:[e]})}function me(){console.log("显示表情面板")}function fe(e,a){if(0===a)return!0;const s=V.value[a-1];return new Date(e.createdAt).getTime()-new Date(s.createdAt).getTime()>3e5}function ve(e){const a=new Date(e);return(new Date).toDateString()===a.toDateString()?a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}):a.toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}function pe(e){return{2:"[图片]",3:"[语音]",4:"[视频]",5:"[文件]",6:"[系统消息]"}[e]||"[未知消息]"}function Ie(){console.log("执行滚动到底部"),G.value="bottom-anchor",i((()=>{const e=m();e.select(".message-list").boundingClientRect(),e.exec((e=>{e[0]&&(B.value=e[0].height+1e3)}))})),setTimeout((()=>{G.value=""}),100)}function _e(){H.value=!0}function ke(){console.log("尝试返回上一页...");const e=o();console.log("当前页面栈长度:",e.length),e.length>1?w({success:()=>{console.log("返回成功")},fail:e=>{console.error("返回失败:",e),ye()}}):(console.log("页面栈只有一页，直接跳转到消息列表"),ye())}function ye(){C({url:"/pages/message/message",success:()=>{console.log("跳转到消息页面成功")},fail:e=>{console.error("跳转到消息页面失败:",e),A({url:"/pages/index/index"})}})}return t((()=>{const e=o(),a=e[e.length-1].options;a.userId&&(O.id=a.userId,O.name=decodeURIComponent(a.name||""),O.avatar=decodeURIComponent(a.avatar||"/static/message/default-avatar.png"),a.conversationId&&"new"!==a.conversationId&&ae(),async function(){const e=n("token");if(console.log("=== 获取用户信息调试 ==="),console.log("token:",e),!e)return console.warn("未找到token，使用默认用户信息"),void ee();try{const{getByUserInfo:a}=await l((()=>import("./api-user-auth.CC_RESsW.js")),__vite__mapDeps([0,1,2])),s=await a(e);if(console.log("API返回的用户信息:",s),s&&200===s.code&&s.data){const e=s.data;N.id=e.userId||e.id,N.nickname=e.nickname||e.name||e.username||"我";let a=e.avatarUrl||e.avatar;console.log("API返回的头像路径:",a),a&&"null"!==a&&"undefined"!==a&&""!==a.trim()?(N.avatar=a,Q.value=!1,console.log("使用API获取的真实头像:",N.avatar)):(N.avatar="/static/message/default-avatar.png",Q.value=!0,console.log("使用默认头像和占位符")),c("userInfo",e)}else console.warn("API返回数据格式错误:",s),ee()}catch(a){console.error("获取用户信息失败:",a),ee()}console.log("=== 最终用户信息 ==="),console.log("currentUser:",N),console.log("currentUser.avatar:",N.avatar)}(),P.onMessage("CHAT",(e=>{if(e.senderId==O.id||e.receiverId==O.id){const a={...e.data,messageId:e.messageId,senderId:e.senderId,isSelf:e.senderId==N.id,status:"received",createdAt:(new Date).toISOString()};V.value.push(a),i((()=>{Ie()})),setTimeout((()=>{Ie()}),100),setTimeout((()=>{Ie()}),300),a.isSelf||async function(e){try{const a=o(),s=a[a.length-1],t=s.options.conversationId;t&&"new"!==t&&await M(t,e)}catch(a){console.error("标记已读失败:",a)}}(a.messageId)}})),P.onMessage("SENT",(e=>{console.log("收到消息发送确认:",e);const a=V.value.findIndex((a=>a.tempId===e.tempId||a.tempId===e.messageId));a>-1&&(V.value[a].status="sent",V.value[a].messageId=e.messageId,console.log("消息状态更新为已发送"))})),P.onMessage("SEND_FAILED",(e=>{console.log("收到消息发送失败通知:",e);const a=V.value.findIndex((a=>a.tempId===e.tempId));a>-1&&(V.value[a].status="failed")})),P.onMessage("USER_STATUS",(e=>{console.log("收到用户状态更新:",e),e.userId==O.id&&($.value=e.isOnline)})),setTimeout((()=>{P.isConnected&&P.send({type:"GET_USER_STATUS",data:{userId:O.id}})}),1e3),async function(){const e=n("token");if(!e)return console.error("没有token，无法连接WebSocket"),void r({title:"请先登录",icon:"none"});try{console.log("正在连接WebSocket..."),await P.connect(e),console.log("WebSocket连接成功"),$.value=!0,setTimeout((()=>{P.isConnected&&P.send({type:"GET_USER_STATUS",data:{userId:O.id}})}),1e3)}catch(a){console.error("WebSocket连接失败:",a),$.value=!1,r({title:"WebSocket连接失败",icon:"none"})}}(),setTimeout((()=>{Ie()}),500))})),R((()=>{console.log("聊天页面显示"),setTimeout((()=>{Ie()}),300)})),u((()=>{K.value&&clearTimeout(K.value)})),(e,a)=>{const s=f,t=U,o=x,l=D,c=E;return v(),d(s,{class:"chat-page"},{default:g((()=>[p(s,{class:"bg-layer"},{default:g((()=>[p(s,{class:"bg-gradient"}),p(s,{class:"overlay-gradient"})])),_:1}),p(s,{class:"content-container"},{default:g((()=>[p(s,{class:"chat-header"},{default:g((()=>[p(s,{class:"header-left",onClick:ke},{default:g((()=>[p(t,{class:"back-icon"},{default:g((()=>[I("‹")])),_:1})])),_:1}),p(s,{class:"header-center"},{default:g((()=>[p(o,{class:"user-avatar",src:O.avatar,mode:"aspectFill",onError:_e},{default:g((()=>[H.value?(v(),d(s,{key:0,class:"avatar-placeholder"})):_("",!0)])),_:1},8,["src"]),p(s,{class:"user-info"},{default:g((()=>[p(t,{class:"user-name"},{default:g((()=>[I(k(O.name),1)])),_:1}),p(t,{class:y(["online-status",{online:$.value}])},{default:g((()=>[I(k($.value?"在线":"离线"),1)])),_:1},8,["class"])])),_:1})])),_:1}),p(s,{class:"header-right"},{default:g((()=>[p(t,{class:"more-icon"},{default:g((()=>[I("⋯")])),_:1})])),_:1})])),_:1}),p(l,{class:"message-list","scroll-y":"","scroll-into-view":G.value,"scroll-top":B.value,onScrolltoupper:se},{default:g((()=>[q.value?(v(),d(s,{key:0,class:"loading-more"},{default:g((()=>[p(t,null,{default:g((()=>[I("加载中...")])),_:1})])),_:1})):_("",!0),(v(!0),h(T,null,S(V.value,((e,a)=>(v(),d(s,{key:e.messageId||a,id:`message-${e.messageId||e.tempId||a}`,class:y(["message-item",{"message-self":e.isSelf}])},{default:g((()=>[fe(e,a)?(v(),d(s,{key:0,class:"time-divider"},{default:g((()=>[p(t,null,{default:g((()=>[I(k(ve(e.createdAt)),1)])),_:2},1024)])),_:2},1024)):_("",!0),p(s,{class:"message-content"},{default:g((()=>[e.isSelf?(v(),h(T,{key:1},[p(s,{class:"message-status-outside"},{default:g((()=>["sending"===e.status?(v(),d(t,{key:0,class:"status-sending"},{default:g((()=>[I("发送中")])),_:1})):"sent"===e.status?(v(),d(t,{key:1,class:"status-sent"},{default:g((()=>[I("已发送")])),_:1})):"read"===e.status?(v(),d(t,{key:2,class:"status-read"},{default:g((()=>[I("已读")])),_:1})):"failed"===e.status?(v(),d(t,{key:3,class:"status-failed",onClick:a=>function(e){if(console.log("重发消息:",e),e.status="sending",P.isConnected)oe(e);else{console.warn("WebSocket未连接，尝试重新连接...");const a=n("token");a?P.connect(a).then((()=>{console.log("重连成功，重新发送消息"),oe(e)})).catch((a=>{console.error("重连失败:",a),e.status="failed",r({title:"重发失败，请检查网络",icon:"none"})})):(e.status="failed",r({title:"重发失败，请重新登录",icon:"none"}))}}(e)},{default:g((()=>[I("重发")])),_:2},1032,["onClick"])):_("",!0)])),_:2},1024),p(s,{class:"message-bubble bubble-self"},{default:g((()=>[1===e.messageType?(v(),d(t,{key:0,class:"message-text"},{default:g((()=>[I(k(e.content),1)])),_:2},1024)):2===e.messageType?(v(),d(o,{key:1,class:"message-image",src:e.mediaUrl,mode:"aspectFit",onClick:a=>ge(e.mediaUrl)},null,8,["src","onClick"])):(v(),d(t,{key:2,class:"message-text"},{default:g((()=>[I(k(pe(e.messageType)),1)])),_:2},1024))])),_:2},1024),p(s,{class:"avatar-wrapper"},{default:g((()=>[p(o,{class:"message-avatar",src:N.avatar||"/static/message/default-avatar.png",mode:"aspectFill",onError:le,onLoad:ne},null,8,["src"]),Q.value?(v(),d(s,{key:0,class:"avatar-placeholder"},{default:g((()=>[p(t,{class:"avatar-text"},{default:g((()=>[I(k(N.nickname?N.nickname.charAt(0):"我"),1)])),_:1})])),_:1})):_("",!0)])),_:1})],64)):(v(),h(T,{key:0},[p(o,{class:"message-avatar",src:O.avatar||"/static/message/default-avatar.png",mode:"aspectFill",onError:ce},null,8,["src"]),p(s,{class:"message-bubble"},{default:g((()=>[1===e.messageType?(v(),d(t,{key:0,class:"message-text"},{default:g((()=>[I(k(e.content),1)])),_:2},1024)):2===e.messageType?(v(),d(o,{key:1,class:"message-image",src:e.mediaUrl,mode:"aspectFit",onClick:a=>ge(e.mediaUrl)},null,8,["src","onClick"])):(v(),d(t,{key:2,class:"message-text"},{default:g((()=>[I(k(pe(e.messageType)),1)])),_:2},1024))])),_:2},1024)],64))])),_:2},1024)])),_:2},1032,["id","class"])))),128)),p(s,{id:"bottom-anchor",style:{height:"1px"}})])),_:1},8,["scroll-into-view","scroll-top"]),p(s,{class:"input-area"},{default:g((()=>[p(s,{class:"input-container"},{default:g((()=>[p(s,{class:"input-tools"},{default:g((()=>[p(t,{class:"tool-icon",onClick:me},{default:g((()=>[I("😊")])),_:1}),p(t,{class:"tool-icon",onClick:de},{default:g((()=>[I("📷")])),_:1})])),_:1}),p(c,{class:"message-input",modelValue:z.value,"onUpdate:modelValue":a[0]||(a[0]=e=>z.value=e),placeholder:"输入消息...",onFocus:ie,onBlur:re,onInput:ue,onConfirm:te},null,8,["modelValue"]),p(s,{class:y(["send-button",{active:z.value.trim()}]),onClick:te},{default:g((()=>[p(t,null,{default:g((()=>[I("发送")])),_:1})])),_:1},8,["class"])])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-d62173aa"]]);export{L as default};
