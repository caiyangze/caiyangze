import{g as e,e as n,E as s,_ as a,r as o,a as t,o as l,G as r,d as c,w as i,s as u,H as d,I as g,i as f,f as m,h,j as v,l as I,m as p,F as k,k as y,n as _,p as C,q as w,u as S,A as T,t as O}from"./index-BpPI9udZ.js";import{getMutualFollowList as A,getConversationList as M,getBatchOnlineStatus as E,getOnlineStatus as F,getUnreadCounts as D}from"./api-chat.BF5K77Hj.js";import{w as $}from"./websocket.DvBY1wJ6.js";function U(){const n=e("token"),s=e("refreshToken"),a=e("userInfo");if(console.log("=== TokençŠ¶æ€æ£€æŸ¥ ==="),console.log("Token:",n?n.substring(0,30)+"...":"null"),console.log("RefreshToken:",s?s.substring(0,30)+"...":"null"),console.log("UserInfo:",a),console.log("Tokené•¿åº¦:",n?n.length:0),n)try{const e=n.split(".");if(3===e.length){const n=JSON.parse(atob(e[1]));console.log("JWT Payload:",n),console.log("Tokenè¿‡æœŸæ—¶é—´:",new Date(1e3*n.exp)),console.log("å½“å‰æ—¶é—´:",new Date),console.log("Tokenæ˜¯å¦è¿‡æœŸ:",1e3*n.exp<Date.now())}}catch(o){console.log("Tokenä¸æ˜¯JWTæ ¼å¼æˆ–è§£æå¤±è´¥:",o)}return{hasToken:!!n,hasRefreshToken:!!s,hasUserInfo:!!a,token:n,tokenLength:n?n.length:0}}const b=async function(){console.log("ğŸ” å¼€å§‹ç™»å½•çŠ¶æ€è¯Šæ–­..."),s({success:e=>{console.log("=== ç½‘ç»œçŠ¶æ€ ==="),console.log("ç½‘ç»œç±»å‹:",e.networkType),console.log("æ˜¯å¦è¿æ¥:","none"!==e.networkType)},fail:e=>{console.error("è·å–ç½‘ç»œçŠ¶æ€å¤±è´¥:",e)}});const e=U();return e.hasToken&&await async function(){console.log("=== æµ‹è¯•APIè¯·æ±‚ ===");const e=U();if(e.hasToken)try{const s=await n({url:"http://localhost:9001/follow/mutual",method:"GET",header:{"Content-Type":"application/json",token:e.token,Authorization:`Bearer ${e.token}`}});return console.log("APIæµ‹è¯•å“åº”:",s),200===s.statusCode?(console.log("âœ… APIè¯·æ±‚æˆåŠŸ"),s.data):(console.error("âŒ APIè¯·æ±‚å¤±è´¥:",s),null)}catch(s){return console.error("âŒ APIè¯·æ±‚å¼‚å¸¸:",s),null}else console.error("æ²¡æœ‰tokenï¼Œæ— æ³•æµ‹è¯•")}(),console.log("=== è¯Šæ–­å»ºè®® ==="),e.hasToken?e.hasUserInfo?console.log("âœ… ç™»å½•çŠ¶æ€çœ‹èµ·æ¥æ­£å¸¸ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨ç«¯é—®é¢˜"):console.log("âš ï¸ æœ‰tokenä½†æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯"):console.log("âŒ æ²¡æœ‰tokenï¼Œè¯·é‡æ–°ç™»å½•"),e},N=a({__name:"message",setup(n){const s=o({}),a=t(0),N=[{name:"å…¨éƒ¨",type:"all"},{name:"æœªè¯»",type:"unread"},{name:"ç³»ç»Ÿ",type:"system"}],P=t([]),x=t(!1);t(new Set),t(new Map);let R=null;async function j(){try{if(0===P.value.filter((e=>e.isFriend)).length)return void console.log("æ²¡æœ‰å¥½å‹ï¼Œè·³è¿‡ä¼šè¯åŠ è½½");x.value=!0;const e=await M();if(200===e.code){const n=e.data.map((e=>({id:e.conversationId,userId:e.otherUserId,name:e.otherUserNickname,avatar:e.otherUserAvatar||"/static/message/default-avatar.png",lastMessage:e.lastMessageContent||"æš‚æ— æ¶ˆæ¯",time:L(e.lastMessageTime),unreadCount:e.unreadCount||0,isFriend:!1})));P.value.forEach((e=>{if(e.isFriend){const s=n.find((n=>n.userId===e.userId));s&&(e.id=s.id,e.lastMessage=s.lastMessage,e.time=s.time,e.unreadCount=s.unreadCount)}})),console.log("ä¼šè¯ä¿¡æ¯å·²æ›´æ–°åˆ°å¥½å‹åˆ—è¡¨ï¼Œä¸æ·»åŠ éå¥½å‹ä¼šè¯")}}catch(e){console.error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:",e)}finally{x.value=!1}}function L(e){if(!e)return"";const n=new Date(e),s=new Date,a=s.getTime()-n.getTime();if(a<864e5&&s.getDate()===n.getDate())return n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});if(a<1728e5)return"æ˜¨å¤©";if(a<6048e5){return["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][n.getDay()]}return n.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}async function G(){try{const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));if(0===e.length)return void console.log("æ²¡æœ‰å¥½å‹ï¼Œè·³è¿‡åœ¨çº¿çŠ¶æ€åŠ è½½");console.log("æ‰¹é‡åŠ è½½å¥½å‹åœ¨çº¿çŠ¶æ€:",e),console.log("å‘é€è¯·æ±‚å‚æ•°:",{userIds:e});const n=await E(e);if(console.log("åœ¨çº¿çŠ¶æ€APIå“åº”:",n),n&&200===n.code){const e=n.data||{};console.log("åœ¨çº¿çŠ¶æ€æ•°æ®:",e),P.value.forEach((n=>{if(n.isFriend){const s=e[n.userId];s?(n.isOnline=s.isOnline||!1,n.lastSeen=s.lastSeen||null):(n.isOnline=!1,n.lastSeen=null)}})),console.log("åœ¨çº¿çŠ¶æ€åŠ è½½å®Œæˆï¼Œæ›´æ–°åçš„å¥½å‹åˆ—è¡¨:",P.value.filter((e=>e.isFriend)).map((e=>({name:e.name,isOnline:e.isOnline,lastSeen:e.lastSeen}))))}else console.error("åœ¨çº¿çŠ¶æ€APIè¿”å›é”™è¯¯:",n),await W()}catch(e){console.error("åŠ è½½å¥½å‹åœ¨çº¿çŠ¶æ€å¤±è´¥:",e),await W()}}async function W(){const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));for(const s of e)try{const e=await F(s);if(200===e.code){const n=P.value.find((e=>e.userId===s));n&&(n.isOnline=e.data.isOnline,n.lastSeen=e.data.lastSeen)}}catch(n){console.error(`è·å–ç”¨æˆ·${s}åœ¨çº¿çŠ¶æ€å¤±è´¥:`,n)}}async function q(){try{const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));if(0===e.length)return void console.log("æ²¡æœ‰å¥½å‹ï¼Œè·³è¿‡æœªè¯»æ¶ˆæ¯æ•°é‡åŠ è½½");console.log("åŠ è½½æœªè¯»æ¶ˆæ¯æ•°é‡:",e),console.log("å‘é€è¯·æ±‚å‚æ•°:",{userIds:e});const n=await D(e);if(console.log("æœªè¯»æ¶ˆæ¯APIå“åº”:",n),n&&200===n.code){const e=n.data||{};console.log("æœªè¯»æ¶ˆæ¯æ•°æ®:",e),P.value.forEach((n=>{if(n.isFriend){const s=e[n.userId];n.unreadCount="number"==typeof s?s:0}})),console.log("æœªè¯»æ¶ˆæ¯æ•°é‡åŠ è½½å®Œæˆï¼Œæ›´æ–°åçš„å¥½å‹åˆ—è¡¨:",P.value.filter((e=>e.isFriend)).map((e=>({name:e.name,unreadCount:e.unreadCount}))))}else console.error("æœªè¯»æ¶ˆæ¯APIè¿”å›é”™è¯¯:",n)}catch(e){console.error("åŠ è½½æœªè¯»æ¶ˆæ¯æ•°é‡å¤±è´¥:",e)}}function z(e){if(!e)return"ç¦»çº¿";const n=new Date-new Date(e),s=Math.floor(n/6e4),a=Math.floor(n/36e5),o=Math.floor(n/864e5);return s<1?"åˆšåˆšç¦»çº¿":s<60?`${s}åˆ†é’Ÿå‰`:a<24?`${a}å°æ—¶å‰`:o<7?`${o}å¤©å‰`:"ç¦»çº¿"}function H(){C({url:"/pages/search/search"})}function J(){g({url:"/pages/square/square"})}return l((()=>{(async function(){try{if(x.value=!0,P.value=[],console.log("=== å¼€å§‹åŠ è½½å¥½å‹åˆ—è¡¨ ==="),!U().hasToken)return console.error("âŒ æ²¡æœ‰tokenï¼Œæ— æ³•åŠ è½½å¥½å‹åˆ—è¡¨"),void u({title:"è¯·å…ˆç™»å½•",icon:"none"});const e=await A();console.log("å¥½å‹åˆ—è¡¨APIå“åº”:",e),200===e.code?e.data&&e.data.length>0?(console.log(`æ‰¾åˆ° ${e.data.length} ä¸ªå¥½å‹`),P.value=e.data.map((e=>({id:null,userId:e.userId,name:e.nickname||e.name||`ç”¨æˆ·${e.userId}`,avatar:e.avatarUrl||e.avatar||"/static/message/default-avatar.png",lastMessage:"ç‚¹å‡»å¼€å§‹èŠå¤©",time:"",unreadCount:0,isFriend:!0,isOnline:!1,lastSeen:e.lastSeen||null}))),await G(),await q()):(console.log("æ²¡æœ‰å¥½å‹æ•°æ®ï¼Œæ¸…ç©ºåˆ—è¡¨"),P.value=[]):(console.error("å¥½å‹åˆ—è¡¨APIè¿”å›é”™è¯¯:",e),P.value=[],u({title:e.message||"è·å–å¥½å‹åˆ—è¡¨å¤±è´¥",icon:"none"}))}catch(e){console.error("åŠ è½½å¥½å‹åˆ—è¡¨å¤±è´¥:",e),P.value=[],400===e.code&&e.message&&e.message.includes("ç”¨æˆ·æœªç™»å½•")?(console.log("æ£€æµ‹åˆ°ç”¨æˆ·æœªç™»å½•é”™è¯¯ï¼Œå¼€å§‹è¯Šæ–­..."),await b(),d({title:"ç™»å½•çŠ¶æ€å¼‚å¸¸",content:"æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•",showCancel:!1,success:()=>{g({url:"/pages/login/login"})}})):(console.log("å¥½å‹åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯:",e),u({title:"åŠ è½½å¤±è´¥: "+(e.message||"ç½‘ç»œé”™è¯¯"),icon:"none"}))}finally{x.value=!1}})().then((()=>{j()})),async function(){try{const n=e("token");n&&(await $.connect(n),$.onMessage("CHAT",(e=>{console.log("æ”¶åˆ°æ–°æ¶ˆæ¯:",e),j()})),$.onMessage("SENT",(e=>{console.log("æ¶ˆæ¯å‘é€æˆåŠŸ:",e)})))}catch(n){console.error("WebSocketè¿æ¥å¤±è´¥:",n)}}(),$.onMessage("USER_STATUS",(e=>{console.log("æ”¶åˆ°ç”¨æˆ·çŠ¶æ€å˜åŒ–:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=e.isOnline,n.lastSeen=e.lastSeen||(new Date).toISOString(),console.log(`ç”¨æˆ·${e.userId}çŠ¶æ€æ›´æ–°ä¸º:`,e.isOnline?"åœ¨çº¿":"ç¦»çº¿"))})),$.onMessage("USER_ONLINE",(e=>{console.log("ç”¨æˆ·ä¸Šçº¿:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=!0,n.lastSeen=(new Date).toISOString())})),$.onMessage("USER_OFFLINE",(e=>{console.log("ç”¨æˆ·ä¸‹çº¿:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=!1,n.lastSeen=e.lastSeen||(new Date).toISOString())})),$.onMessage("NEW_MESSAGE",(e=>{console.log("æ”¶åˆ°æ–°æ¶ˆæ¯:",e),function(e){const n=P.value.find((n=>n.userId===e.senderId));if(n){n.lastMessage=e.content||"æ–°æ¶ˆæ¯",n.time=L(new Date(e.timestamp)),n.unreadCount=(n.unreadCount||0)+1;const s=P.value.findIndex((n=>n.userId===e.senderId));if(s>0){const e=P.value.splice(s,1)[0];P.value.unshift(e)}console.log(`æ”¶åˆ°æ¥è‡ªç”¨æˆ·${e.senderId}çš„æ–°æ¶ˆæ¯ï¼Œæœªè¯»æ•°é‡: ${n.unreadCount}`)}}(e)})),$.onMessage("UNREAD_COUNT_CHANGED",(e=>{console.log("æœªè¯»æ¶ˆæ¯æ•°é‡å˜åŒ–:",e),function(e,n){const s=P.value.find((n=>n.userId===e));s&&(s.unreadCount=n)}(e.userId,e.unreadCount)})),R=setInterval((()=>{P.value.length>0&&(G(),q())}),3e4)})),r((()=>{$.disconnect(),R&&(clearInterval(R),R=null)})),(e,n)=>{const o=f,t=w,l=S;return m(),c(o,{class:"message-page"},{default:i((()=>[h(o,{class:"bg-layer"},{default:i((()=>[h(o,{class:"bg-gradient"}),h(o,{class:"overlay-gradient"})])),_:1}),h(o,{class:"content-container"},{default:i((()=>[h(o,{class:"header"},{default:i((()=>[h(t,{class:"page-title"},{default:i((()=>[v("æ¶ˆæ¯")])),_:1}),h(o,{class:"search-box",onClick:H},{default:i((()=>[h(t,{class:"search-icon"}),h(t,{class:"search-placeholder"},{default:i((()=>[v("æœç´¢")])),_:1})])),_:1})])),_:1}),h(o,{class:"message-tabs"},{default:i((()=>[(m(),I(k,null,p(N,((e,n)=>h(o,{key:n,class:T(["message-tab",{active:a.value===n}]),onClick:e=>function(e){a.value=e}(n)},{default:i((()=>[h(t,null,{default:i((()=>[v(O(e.name),1)])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])),_:1}),h(o,{class:"message-list"},{default:i((()=>[(m(!0),I(k,null,p(P.value,((e,n)=>(m(),c(o,{class:"message-item",key:n,onClick:n=>function(e){try{const n=e.id||"new",s=e.userId||"",a=e.name||"æœªçŸ¥ç”¨æˆ·",o=e.avatar||"/static/message/default-avatar.png";console.log("å‡†å¤‡å¯¼èˆªåˆ°èŠå¤©é¡µé¢:",{conversationId:n,userId:s,name:a,avatar:o}),C({url:`/pages/message/chat?conversationId=${n}&userId=${s}&name=${encodeURIComponent(a)}&avatar=${encodeURIComponent(o)}`,success:()=>{console.log("å¯¼èˆªæˆåŠŸ");const n=P.value.findIndex((n=>n.userId===e.userId));-1!==n&&(P.value[n].unreadCount=0)},fail:e=>{console.error("å¯¼èˆªå¤±è´¥:",e),u({title:"æ‰“å¼€èŠå¤©é¡µé¢å¤±è´¥",icon:"none"})}})}catch(n){console.error("openChat error:",n),u({title:"æ“ä½œå¤±è´¥",icon:"none"})}}(e)},{default:i((()=>[h(o,{class:"avatar-container"},{default:i((()=>[h(l,{class:"user-avatar",src:s[`message${n}`]?"/static/message/default-avatar.png":e.avatar||"/static/message/default-avatar.png",mode:"aspectFill",onError:e=>{s[`message${n}`]=!0}},null,8,["src","onError"]),s[`message${n}`]?(m(),c(o,{key:0,class:"avatar-placeholder"},{default:i((()=>[h(t,{class:"avatar-text"},{default:i((()=>[v(O(e.name?e.name.charAt(0):"?"),1)])),_:2},1024)])),_:2},1024)):y("",!0),e.isFriend?(m(),c(o,{key:1,class:T(["online-indicator",{online:e.isOnline}])},null,8,["class"])):y("",!0),e.unreadCount>0?(m(),c(o,{key:2,class:"unread-badge"},{default:i((()=>[v(O(e.unreadCount>99?"99+":e.unreadCount),1)])),_:2},1024)):y("",!0)])),_:2},1024),h(o,{class:"message-content"},{default:i((()=>[h(o,{class:"message-top"},{default:i((()=>[h(t,{class:"user-name"},{default:i((()=>[v(O(e.name),1)])),_:2},1024),h(o,{class:"message-right"},{default:i((()=>[e.isFriend?(m(),c(t,{key:0,class:T(["online-status",{online:e.isOnline}])},{default:i((()=>[v(O(e.isOnline?"åœ¨çº¿":z(e.lastSeen)),1)])),_:2},1032,["class"])):y("",!0),h(t,{class:"message-time"},{default:i((()=>[v(O(e.time),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),h(t,{class:"message-preview"},{default:i((()=>[v(O(e.lastMessage),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),0===P.value.length?(m(),c(o,{key:0,class:"empty-state"},{default:i((()=>[h(l,{class:"empty-icon",src:"/static/message/empty.png",mode:"aspectFit"}),h(t,{class:"empty-text"},{default:i((()=>[v("æš‚æ— æ¶ˆæ¯")])),_:1}),h(o,{class:"action-button",onClick:J},{default:i((()=>[v("å»å¹¿åœºçœ‹çœ‹")])),_:1})])),_:1})):y("",!0)])),_:1}),h(_)])),_:1})}}},[["__scopeId","data-v-a9a360d8"]]);export{N as default};
