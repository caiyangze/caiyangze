import{g as e,e as n,E as s,_ as a,r as o,a as t,o as l,G as r,d as c,w as i,s as u,H as d,I as g,i as f,f as m,h,j as v,l as I,m as p,F as k,k as y,n as _,p as C,q as w,u as S,A as T,t as O}from"./index-BpPI9udZ.js";import{getMutualFollowList as A,getConversationList as M,getBatchOnlineStatus as E,getOnlineStatus as F,getUnreadCounts as D}from"./api-chat.BF5K77Hj.js";import{w as $}from"./websocket.DvBY1wJ6.js";function U(){const n=e("token"),s=e("refreshToken"),a=e("userInfo");if(console.log("=== Token状态检查 ==="),console.log("Token:",n?n.substring(0,30)+"...":"null"),console.log("RefreshToken:",s?s.substring(0,30)+"...":"null"),console.log("UserInfo:",a),console.log("Token长度:",n?n.length:0),n)try{const e=n.split(".");if(3===e.length){const n=JSON.parse(atob(e[1]));console.log("JWT Payload:",n),console.log("Token过期时间:",new Date(1e3*n.exp)),console.log("当前时间:",new Date),console.log("Token是否过期:",1e3*n.exp<Date.now())}}catch(o){console.log("Token不是JWT格式或解析失败:",o)}return{hasToken:!!n,hasRefreshToken:!!s,hasUserInfo:!!a,token:n,tokenLength:n?n.length:0}}const b=async function(){console.log("🔍 开始登录状态诊断..."),s({success:e=>{console.log("=== 网络状态 ==="),console.log("网络类型:",e.networkType),console.log("是否连接:","none"!==e.networkType)},fail:e=>{console.error("获取网络状态失败:",e)}});const e=U();return e.hasToken&&await async function(){console.log("=== 测试API请求 ===");const e=U();if(e.hasToken)try{const s=await n({url:"http://localhost:9001/follow/mutual",method:"GET",header:{"Content-Type":"application/json",token:e.token,Authorization:`Bearer ${e.token}`}});return console.log("API测试响应:",s),200===s.statusCode?(console.log("✅ API请求成功"),s.data):(console.error("❌ API请求失败:",s),null)}catch(s){return console.error("❌ API请求异常:",s),null}else console.error("没有token，无法测试")}(),console.log("=== 诊断建议 ==="),e.hasToken?e.hasUserInfo?console.log("✅ 登录状态看起来正常，可能是服务器端问题"):console.log("⚠️ 有token但没有用户信息，可能需要重新获取用户信息"):console.log("❌ 没有token，请重新登录"),e},N=a({__name:"message",setup(n){const s=o({}),a=t(0),N=[{name:"全部",type:"all"},{name:"未读",type:"unread"},{name:"系统",type:"system"}],P=t([]),x=t(!1);t(new Set),t(new Map);let R=null;async function j(){try{if(0===P.value.filter((e=>e.isFriend)).length)return void console.log("没有好友，跳过会话加载");x.value=!0;const e=await M();if(200===e.code){const n=e.data.map((e=>({id:e.conversationId,userId:e.otherUserId,name:e.otherUserNickname,avatar:e.otherUserAvatar||"/static/message/default-avatar.png",lastMessage:e.lastMessageContent||"暂无消息",time:L(e.lastMessageTime),unreadCount:e.unreadCount||0,isFriend:!1})));P.value.forEach((e=>{if(e.isFriend){const s=n.find((n=>n.userId===e.userId));s&&(e.id=s.id,e.lastMessage=s.lastMessage,e.time=s.time,e.unreadCount=s.unreadCount)}})),console.log("会话信息已更新到好友列表，不添加非好友会话")}}catch(e){console.error("加载会话列表失败:",e)}finally{x.value=!1}}function L(e){if(!e)return"";const n=new Date(e),s=new Date,a=s.getTime()-n.getTime();if(a<864e5&&s.getDate()===n.getDate())return n.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});if(a<1728e5)return"昨天";if(a<6048e5){return["周日","周一","周二","周三","周四","周五","周六"][n.getDay()]}return n.toLocaleDateString("zh-CN",{month:"2-digit",day:"2-digit"})}async function G(){try{const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));if(0===e.length)return void console.log("没有好友，跳过在线状态加载");console.log("批量加载好友在线状态:",e),console.log("发送请求参数:",{userIds:e});const n=await E(e);if(console.log("在线状态API响应:",n),n&&200===n.code){const e=n.data||{};console.log("在线状态数据:",e),P.value.forEach((n=>{if(n.isFriend){const s=e[n.userId];s?(n.isOnline=s.isOnline||!1,n.lastSeen=s.lastSeen||null):(n.isOnline=!1,n.lastSeen=null)}})),console.log("在线状态加载完成，更新后的好友列表:",P.value.filter((e=>e.isFriend)).map((e=>({name:e.name,isOnline:e.isOnline,lastSeen:e.lastSeen}))))}else console.error("在线状态API返回错误:",n),await W()}catch(e){console.error("加载好友在线状态失败:",e),await W()}}async function W(){const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));for(const s of e)try{const e=await F(s);if(200===e.code){const n=P.value.find((e=>e.userId===s));n&&(n.isOnline=e.data.isOnline,n.lastSeen=e.data.lastSeen)}}catch(n){console.error(`获取用户${s}在线状态失败:`,n)}}async function q(){try{const e=P.value.filter((e=>e.isFriend)).map((e=>e.userId));if(0===e.length)return void console.log("没有好友，跳过未读消息数量加载");console.log("加载未读消息数量:",e),console.log("发送请求参数:",{userIds:e});const n=await D(e);if(console.log("未读消息API响应:",n),n&&200===n.code){const e=n.data||{};console.log("未读消息数据:",e),P.value.forEach((n=>{if(n.isFriend){const s=e[n.userId];n.unreadCount="number"==typeof s?s:0}})),console.log("未读消息数量加载完成，更新后的好友列表:",P.value.filter((e=>e.isFriend)).map((e=>({name:e.name,unreadCount:e.unreadCount}))))}else console.error("未读消息API返回错误:",n)}catch(e){console.error("加载未读消息数量失败:",e)}}function z(e){if(!e)return"离线";const n=new Date-new Date(e),s=Math.floor(n/6e4),a=Math.floor(n/36e5),o=Math.floor(n/864e5);return s<1?"刚刚离线":s<60?`${s}分钟前`:a<24?`${a}小时前`:o<7?`${o}天前`:"离线"}function H(){C({url:"/pages/search/search"})}function J(){g({url:"/pages/square/square"})}return l((()=>{(async function(){try{if(x.value=!0,P.value=[],console.log("=== 开始加载好友列表 ==="),!U().hasToken)return console.error("❌ 没有token，无法加载好友列表"),void u({title:"请先登录",icon:"none"});const e=await A();console.log("好友列表API响应:",e),200===e.code?e.data&&e.data.length>0?(console.log(`找到 ${e.data.length} 个好友`),P.value=e.data.map((e=>({id:null,userId:e.userId,name:e.nickname||e.name||`用户${e.userId}`,avatar:e.avatarUrl||e.avatar||"/static/message/default-avatar.png",lastMessage:"点击开始聊天",time:"",unreadCount:0,isFriend:!0,isOnline:!1,lastSeen:e.lastSeen||null}))),await G(),await q()):(console.log("没有好友数据，清空列表"),P.value=[]):(console.error("好友列表API返回错误:",e),P.value=[],u({title:e.message||"获取好友列表失败",icon:"none"}))}catch(e){console.error("加载好友列表失败:",e),P.value=[],400===e.code&&e.message&&e.message.includes("用户未登录")?(console.log("检测到用户未登录错误，开始诊断..."),await b(),d({title:"登录状态异常",content:"检测到登录状态异常，请重新登录",showCancel:!1,success:()=>{g({url:"/pages/login/login"})}})):(console.log("好友列表加载失败，错误信息:",e),u({title:"加载失败: "+(e.message||"网络错误"),icon:"none"}))}finally{x.value=!1}})().then((()=>{j()})),async function(){try{const n=e("token");n&&(await $.connect(n),$.onMessage("CHAT",(e=>{console.log("收到新消息:",e),j()})),$.onMessage("SENT",(e=>{console.log("消息发送成功:",e)})))}catch(n){console.error("WebSocket连接失败:",n)}}(),$.onMessage("USER_STATUS",(e=>{console.log("收到用户状态变化:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=e.isOnline,n.lastSeen=e.lastSeen||(new Date).toISOString(),console.log(`用户${e.userId}状态更新为:`,e.isOnline?"在线":"离线"))})),$.onMessage("USER_ONLINE",(e=>{console.log("用户上线:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=!0,n.lastSeen=(new Date).toISOString())})),$.onMessage("USER_OFFLINE",(e=>{console.log("用户下线:",e);const n=P.value.find((n=>n.userId===e.userId));n&&(n.isOnline=!1,n.lastSeen=e.lastSeen||(new Date).toISOString())})),$.onMessage("NEW_MESSAGE",(e=>{console.log("收到新消息:",e),function(e){const n=P.value.find((n=>n.userId===e.senderId));if(n){n.lastMessage=e.content||"新消息",n.time=L(new Date(e.timestamp)),n.unreadCount=(n.unreadCount||0)+1;const s=P.value.findIndex((n=>n.userId===e.senderId));if(s>0){const e=P.value.splice(s,1)[0];P.value.unshift(e)}console.log(`收到来自用户${e.senderId}的新消息，未读数量: ${n.unreadCount}`)}}(e)})),$.onMessage("UNREAD_COUNT_CHANGED",(e=>{console.log("未读消息数量变化:",e),function(e,n){const s=P.value.find((n=>n.userId===e));s&&(s.unreadCount=n)}(e.userId,e.unreadCount)})),R=setInterval((()=>{P.value.length>0&&(G(),q())}),3e4)})),r((()=>{$.disconnect(),R&&(clearInterval(R),R=null)})),(e,n)=>{const o=f,t=w,l=S;return m(),c(o,{class:"message-page"},{default:i((()=>[h(o,{class:"bg-layer"},{default:i((()=>[h(o,{class:"bg-gradient"}),h(o,{class:"overlay-gradient"})])),_:1}),h(o,{class:"content-container"},{default:i((()=>[h(o,{class:"header"},{default:i((()=>[h(t,{class:"page-title"},{default:i((()=>[v("消息")])),_:1}),h(o,{class:"search-box",onClick:H},{default:i((()=>[h(t,{class:"search-icon"}),h(t,{class:"search-placeholder"},{default:i((()=>[v("搜索")])),_:1})])),_:1})])),_:1}),h(o,{class:"message-tabs"},{default:i((()=>[(m(),I(k,null,p(N,((e,n)=>h(o,{key:n,class:T(["message-tab",{active:a.value===n}]),onClick:e=>function(e){a.value=e}(n)},{default:i((()=>[h(t,null,{default:i((()=>[v(O(e.name),1)])),_:2},1024)])),_:2},1032,["class","onClick"]))),64))])),_:1}),h(o,{class:"message-list"},{default:i((()=>[(m(!0),I(k,null,p(P.value,((e,n)=>(m(),c(o,{class:"message-item",key:n,onClick:n=>function(e){try{const n=e.id||"new",s=e.userId||"",a=e.name||"未知用户",o=e.avatar||"/static/message/default-avatar.png";console.log("准备导航到聊天页面:",{conversationId:n,userId:s,name:a,avatar:o}),C({url:`/pages/message/chat?conversationId=${n}&userId=${s}&name=${encodeURIComponent(a)}&avatar=${encodeURIComponent(o)}`,success:()=>{console.log("导航成功");const n=P.value.findIndex((n=>n.userId===e.userId));-1!==n&&(P.value[n].unreadCount=0)},fail:e=>{console.error("导航失败:",e),u({title:"打开聊天页面失败",icon:"none"})}})}catch(n){console.error("openChat error:",n),u({title:"操作失败",icon:"none"})}}(e)},{default:i((()=>[h(o,{class:"avatar-container"},{default:i((()=>[h(l,{class:"user-avatar",src:s[`message${n}`]?"/static/message/default-avatar.png":e.avatar||"/static/message/default-avatar.png",mode:"aspectFill",onError:e=>{s[`message${n}`]=!0}},null,8,["src","onError"]),s[`message${n}`]?(m(),c(o,{key:0,class:"avatar-placeholder"},{default:i((()=>[h(t,{class:"avatar-text"},{default:i((()=>[v(O(e.name?e.name.charAt(0):"?"),1)])),_:2},1024)])),_:2},1024)):y("",!0),e.isFriend?(m(),c(o,{key:1,class:T(["online-indicator",{online:e.isOnline}])},null,8,["class"])):y("",!0),e.unreadCount>0?(m(),c(o,{key:2,class:"unread-badge"},{default:i((()=>[v(O(e.unreadCount>99?"99+":e.unreadCount),1)])),_:2},1024)):y("",!0)])),_:2},1024),h(o,{class:"message-content"},{default:i((()=>[h(o,{class:"message-top"},{default:i((()=>[h(t,{class:"user-name"},{default:i((()=>[v(O(e.name),1)])),_:2},1024),h(o,{class:"message-right"},{default:i((()=>[e.isFriend?(m(),c(t,{key:0,class:T(["online-status",{online:e.isOnline}])},{default:i((()=>[v(O(e.isOnline?"在线":z(e.lastSeen)),1)])),_:2},1032,["class"])):y("",!0),h(t,{class:"message-time"},{default:i((()=>[v(O(e.time),1)])),_:2},1024)])),_:2},1024)])),_:2},1024),h(t,{class:"message-preview"},{default:i((()=>[v(O(e.lastMessage),1)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),0===P.value.length?(m(),c(o,{key:0,class:"empty-state"},{default:i((()=>[h(l,{class:"empty-icon",src:"/static/message/empty.png",mode:"aspectFit"}),h(t,{class:"empty-text"},{default:i((()=>[v("暂无消息")])),_:1}),h(o,{class:"action-button",onClick:J},{default:i((()=>[v("去广场看看")])),_:1})])),_:1})):y("",!0)])),_:1}),h(_)])),_:1})}}},[["__scopeId","data-v-a9a360d8"]]);export{N as default};
