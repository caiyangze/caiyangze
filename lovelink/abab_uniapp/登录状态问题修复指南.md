# 登录状态问题修复指南

## 🚨 **问题现象**
API请求返回 `{code: 400, message: "用户未登录", data: null}`

## 🔍 **问题排查步骤**

### 1. 检查Token状态
在浏览器控制台执行以下代码：
```javascript
// 导入调试工具
import { checkTokenStatus, diagnoseLoginStatus } from '@/utils/token-debug';

// 检查token状态
checkTokenStatus();

// 完整诊断
diagnoseLoginStatus();
```

### 2. 手动检查存储
```javascript
// 检查本地存储
console.log('Token:', uni.getStorageSync('token'));
console.log('RefreshToken:', uni.getStorageSync('refreshToken'));
console.log('UserInfo:', uni.getStorageSync('userInfo'));
```

### 3. 检查请求头
在Network标签中查看请求头是否包含：
- `token: your_token_here`
- `Authorization: Bearer your_token_here`

## 🛠️ **常见解决方案**

### 方案1: 重新登录
```javascript
// 清除登录信息
uni.removeStorageSync('token');
uni.removeStorageSync('refreshToken');
uni.removeStorageSync('userInfo');

// 跳转到登录页
uni.reLaunch({
  url: '/pages/login/login'
});
```

### 方案2: 检查Token格式
```javascript
const token = uni.getStorageSync('token');
if (token) {
  console.log('Token长度:', token.length);
  console.log('Token前20位:', token.substring(0, 20));
  
  // 如果是JWT，检查是否过期
  try {
    const parts = token.split('.');
    if (parts.length === 3) {
      const payload = JSON.parse(atob(parts[1]));
      console.log('Token过期时间:', new Date(payload.exp * 1000));
      console.log('是否过期:', payload.exp * 1000 < Date.now());
    }
  } catch (e) {
    console.log('Token不是JWT格式');
  }
}
```

### 方案3: 手动设置Token
如果确定有有效的token，可以手动设置：
```javascript
// 设置token（替换为实际的token）
const validToken = 'your_actual_token_here';
uni.setStorageSync('token', validToken);

// 重新加载页面
location.reload();
```

### 方案4: 检查后端Token验证
确保后端接口能正确识别以下请求头格式：
- `token: xxx`
- `Authorization: Bearer xxx`

## 🔧 **已添加的修复措施**

### 1. 双重Token头设置
```javascript
// 在http.js中同时设置两种格式
if (token) {
  config.header['token'] = token;
  config.header['Authorization'] = `Bearer ${token}`;
}
```

### 2. 详细的调试日志
```javascript
// 请求前记录token状态
console.log('当前token:', token ? token.substring(0, 20) + '...' : 'null');
console.log('请求URL:', config.url);
```

### 3. 智能错误处理
```javascript
// 检测到登录错误时自动诊断
if (error.code === 400 && error.message.includes('用户未登录')) {
  await diagnoseLoginStatus();
  // 提示用户重新登录
}
```

## 🧪 **测试步骤**

### 1. 基础测试
1. 打开开发者工具控制台
2. 进入消息页面
3. 查看控制台输出的token信息
4. 检查Network标签中的请求头

### 2. API测试
```javascript
// 直接测试API
import { testApiRequest } from '@/utils/token-debug';
testApiRequest();
```

### 3. 登录流程测试
1. 清除所有存储：`uni.clearStorageSync()`
2. 重新登录
3. 检查token是否正确保存
4. 测试API调用

## 🎯 **预期结果**

修复后应该看到：
- ✅ 控制台显示有效的token信息
- ✅ 请求头包含正确的token
- ✅ API返回正常数据而不是"用户未登录"错误
- ✅ 好友列表正常加载

## 🚨 **紧急修复方案**

如果问题仍然存在，可以尝试：

### 1. 强制重新登录
```javascript
// 在任何页面的控制台执行
uni.removeStorageSync('token');
uni.removeStorageSync('refreshToken');
uni.removeStorageSync('userInfo');
uni.reLaunch({ url: '/pages/login/login' });
```

### 2. 检查服务器状态
```bash
# 检查后端服务是否正常
curl -H "token: your_token" http://localhost:9001/follow/mutual
```

### 3. 临时绕过验证（仅开发环境）
在后端临时关闭token验证，确认是token问题还是其他问题。

## 📞 **联系支持**

如果以上方案都无效，请提供：
1. 控制台完整错误日志
2. Network标签中的请求详情
3. 当前token值（脱敏后的前20位）
4. 登录时间和方式

---

**注意**：此问题通常是token过期、格式错误或请求头设置问题导致的，按照上述步骤排查通常能解决。
