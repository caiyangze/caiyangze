# 聊天功能使用说明

## 功能概述

本聊天功能实现了基于互相关注关系的实时聊天系统，用户只能与互相关注的好友进行聊天，确保了社交的安全性和私密性。

## 主要特性

### ✅ 已实现功能

1. **好友列表显示**
   - 在消息页面显示互相关注的好友列表
   - 支持头像、昵称、在线状态显示
   - 点击好友头像进入聊天页面

2. **实时聊天**
   - WebSocket实时消息传递
   - 支持文本消息发送和接收
   - 消息状态显示（发送中、已送达、已读）
   - 消息时间显示

3. **聊天界面**
   - 美观的聊天气泡设计
   - 自动滚动到最新消息
   - 支持消息重发
   - 输入状态提示

4. **权限控制**
   - 基于互相关注关系的聊天权限
   - JWT token身份验证
   - 安全的WebSocket连接

### 🚧 待完善功能

1. **多媒体消息**
   - 图片消息发送
   - 语音消息
   - 视频消息
   - 文件传输

2. **消息管理**
   - 消息撤回
   - 消息删除
   - 聊天记录搜索

3. **用户体验**
   - 表情包支持
   - 消息推送通知
   - 离线消息处理

## 文件结构

```
abab_uniapp/
├── api/
│   └── chat.js                    # 聊天相关API
├── utils/
│   └── websocket.js              # WebSocket管理器
├── pages/
│   └── message/
│       ├── message.vue           # 消息列表页面（好友列表）
│       └── chat.vue              # 聊天页面
└── static/
    └── message/
        └── default-avatar.png    # 默认头像
```

## API接口

### 后端接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/follow/mutual` | GET | 获取互相关注的好友列表 |
| `/chat/conversations` | GET | 获取会话列表 |
| `/chat/history/{conversationId}` | GET | 获取聊天记录 |
| `/chat/send` | POST | 发送消息（HTTP） |
| `/chat/read` | POST | 标记消息已读 |
| WebSocket: `/chat` | WS | 实时消息传递 |

### 前端API调用

```javascript
// 获取好友列表
import { getMutualFollowList } from '@/api/chat';
const friends = await getMutualFollowList();

// WebSocket连接
import wsManager from '@/utils/websocket';
await wsManager.connect(token);

// 发送消息
wsManager.sendChatMessage(receiverId, content, messageType);
```

## 使用流程

### 1. 用户登录
确保用户已登录并获得有效的JWT token。

### 2. 查看好友列表
- 进入消息页面 (`/pages/message/message`)
- 系统自动加载互相关注的好友列表
- 显示好友头像、昵称等信息

### 3. 开始聊天
- 点击好友头像进入聊天页面
- 系统建立WebSocket连接
- 加载历史聊天记录（如果有）

### 4. 发送消息
- 在输入框输入消息内容
- 点击发送按钮或按回车键发送
- 消息通过WebSocket实时传递

### 5. 接收消息
- 实时接收好友发送的消息
- 自动滚动到最新消息
- 显示消息状态和时间

## 配置说明

### 1. 服务器配置

确保后端服务正常运行：
- User服务：http://localhost:9001
- WebSocket服务：ws://localhost:9001/chat

### 2. 前端配置

在 `api/config.js` 中配置服务器地址：

```javascript
export const ENV = {
  development: {
    BASE_URL: 'http://localhost:9001',
    WS_URL: 'ws://localhost:9001'
  }
};
```

### 3. 权限配置

确保用户之间已建立互相关注关系：
- 用户A关注用户B
- 用户B关注用户A
- 两者才能进行聊天

## 测试方法

### 1. 使用测试页面
访问 `/pages/test/chat-test` 进行功能测试：
- 测试API接口
- 测试WebSocket连接
- 测试消息发送

### 2. 手动测试
1. 创建两个测试账号
2. 让两个账号互相关注
3. 分别登录进行聊天测试

### 3. 调试方法
- 查看浏览器控制台日志
- 检查网络请求状态
- 验证WebSocket连接状态

## 常见问题

### 1. 好友列表为空
- 检查是否有互相关注的用户
- 确认API接口返回数据
- 验证用户登录状态

### 2. WebSocket连接失败
- 检查服务器是否启动
- 验证token是否有效
- 确认网络连接状态

### 3. 消息发送失败
- 检查WebSocket连接状态
- 验证接收者ID是否正确
- 确认用户权限

### 4. 消息不能实时接收
- 检查WebSocket连接
- 验证消息监听器
- 确认页面是否在前台

## 开发建议

### 1. 性能优化
- 实现消息分页加载
- 添加消息缓存机制
- 优化WebSocket重连逻辑

### 2. 用户体验
- 添加加载状态提示
- 实现消息推送通知
- 优化界面响应速度

### 3. 安全性
- 加强消息内容过滤
- 实现消息加密传输
- 添加防刷机制

## 后续开发计划

1. **多媒体消息支持**
2. **群聊功能**
3. **消息推送**
4. **聊天记录云同步**
5. **表情包系统**

---

如有问题，请查看控制台日志或联系开发团队。
